<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expense Titan Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { 
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }, 
                        dark: '#0f172a', surface: '#f8fafc' 
                    },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .glass-dark { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; }
        .nav-item.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; }
        .mob-nav-item.active { color: #2563eb; }
        .admin-table th { background-color: #f1f5f9; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        .admin-table td { white-space: nowrap; border-bottom: 1px solid #f1f5f9; padding: 12px; }
        .toast-enter { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .shimmer { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="text-slate-600 h-screen flex flex-col lg:flex-row overflow-hidden font-sans">

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <div id="admin-modal" class="hidden fixed inset-0 z-[120] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-slate-900 mb-6" id="admin-modal-title">Edit</h3>
            <div id="admin-modal-fields" class="space-y-4"></div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl">Cancel</button>
                <button onclick="submitAdminForm()" class="flex-1 py-3 font-bold text-white bg-brand-600 rounded-xl hover:bg-brand-700">Save</button>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="hidden fixed inset-0 z-[110] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <div class="text-center mb-6"><div class="w-14 h-14 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3 border border-slate-100 shadow-sm"><i class="fa-solid fa-lock text-brand-600 text-xl"></i></div><h3 class="text-xl font-bold text-slate-900">Admin Access</h3></div>
            <input type="password" id="admin-password" placeholder="Enter Admin Password" class="w-full p-4 border border-slate-200 rounded-2xl bg-slate-50 font-bold mb-6 focus:ring-2 focus:ring-brand-500 outline-none text-center tracking-widest">
            <div class="flex gap-3"><button onclick="document.getElementById('admin-login-modal').classList.add('hidden')" class="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl hover:bg-slate-200">Cancel</button><button onclick="submitAdminLogin()" id="btn-admin-login" class="flex-1 py-3 font-bold text-white bg-brand-600 rounded-xl hover:bg-brand-700">Login</button></div>
        </div>
    </div>

    <div id="cat-modal" class="hidden fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl animate-slide-up">
            <h3 class="text-xl font-bold text-slate-900 mb-6">New Category</h3>
            <input type="text" id="new-cat-name" placeholder="Category Name" class="w-full p-4 border border-slate-200 rounded-2xl bg-slate-50 font-bold text-slate-800 mb-6 focus:ring-2 focus:ring-brand-500 outline-none">
            <button onclick="saveCategory()" id="btn-save-cat" class="w-full py-4 font-bold text-white bg-brand-600 rounded-2xl hover:bg-brand-700">Create</button>
        </div>
    </div>

    <div id="auth-view" class="fixed inset-0 z-50 bg-white flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[40px] shadow-2xl flex overflow-hidden border border-slate-100">
            <div class="hidden lg:flex w-5/12 bg-dark relative items-center justify-center p-12 overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-brand-600 to-indigo-900 opacity-90"></div>
                <div class="absolute -bottom-24 -left-24 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
                <div class="relative z-10 text-white"><h1 class="text-5xl font-bold mb-6">Expense<br>Titan.</h1><p class="text-indigo-100 text-lg opacity-90">Professional Financial Dashboard.</p></div>
            </div>
            <div class="w-full lg:w-7/12 p-8 lg:p-20 flex flex-col justify-center bg-white">
                <div class="max-w-md mx-auto w-full">
                    <h2 class="text-3xl font-bold text-slate-900 mb-2">Welcome</h2>
                    <p class="text-slate-400 mb-8">Login to manage your expenses.</p>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-8"><button onclick="toggleAuth('login')" id="tab-login" class="flex-1 bg-white shadow-sm py-3 rounded-xl font-bold text-slate-800 text-sm transition">Log In</button><button onclick="toggleAuth('register')" id="tab-reg" class="flex-1 text-slate-500 py-3 rounded-xl font-bold text-sm transition">Register</button></div>
                    <form onsubmit="handleAuth(event)" class="space-y-5"><input type="text" id="auth-user" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-semibold outline-none focus:ring-2 focus:ring-brand-500 transition" placeholder="Username" required><input type="password" id="auth-pass" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-semibold outline-none focus:ring-2 focus:ring-brand-500 transition" placeholder="Password" required><button id="btn-auth" class="w-full bg-brand-600 text-white font-bold py-4 rounded-2xl hover:bg-brand-700 transition shadow-xl mt-4">Sign In</button></form>
                    <div class="mt-8 text-center"><button onclick="document.getElementById('admin-login-modal').classList.remove('hidden')" class="text-xs font-bold text-slate-400 hover:text-brand-600 uppercase tracking-wider flex items-center justify-center gap-2 mx-auto"><i class="fa-solid fa-user-shield mr-1"></i> Admin Portal</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden fixed inset-0 z-50 bg-slate-50 flex flex-col h-full w-full">
        <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm">
            <h2 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-shield-halved text-brand-600 mr-2"></i> Admin Panel</h2>
            <button onclick="logoutAdmin()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold text-xs hover:bg-slate-200">Logout</button>
        </header>
        <main class="flex-1 overflow-hidden p-4 lg:p-8 flex flex-col gap-4">
            <div class="flex gap-4 items-center">
                <label class="font-bold text-slate-600">Sheet:</label>
                <select id="admin-sheet-select" onchange="loadAdminSheet()" class="p-2 border border-slate-300 rounded-lg bg-white font-semibold outline-none focus:border-brand-500 flex-1 lg:flex-none lg:w-64"><option>Loading...</option></select>
                <button onclick="openAdminAdd()" class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-brand-700"><i class="fa-solid fa-plus lg:mr-2"></i> <span class="hidden lg:inline">Add Row</span></button>
            </div>
            <div class="flex-1 glass p-4 lg:p-6 rounded-3xl flex flex-col overflow-hidden border border-white">
                <div class="flex-1 bg-white border border-slate-200 rounded-2xl overflow-auto custom-scroll">
                    <table class="admin-table w-full text-left text-sm border-collapse min-w-[800px]">
                        <thead id="admin-thead" class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200"></thead>
                        <tbody id="admin-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="app-view" class="hidden flex-1 flex flex-col lg:flex-row h-full w-full">
        <aside class="hidden lg:flex w-72 bg-white border-r border-slate-200 flex-col z-20 shadow-sm">
            <div class="h-24 flex items-center px-8 border-b border-slate-50"><div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fa-solid fa-cube text-xl"></i></div><span class="ml-3 font-bold text-xl text-slate-800">Titan<span class="text-brand-600">Pro</span></span></div>
            <nav class="p-6 space-y-2 flex-1"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 pl-3">Menu</p><button onclick="switchTab('dashboard')" id="desk-nav-dashboard" class="nav-item active w-full flex items-center p-4 rounded-2xl text-slate-500 gap-4"><i class="fa-solid fa-layer-group text-lg w-6 text-center"></i> Overview</button><button onclick="switchTab('analytics')" id="desk-nav-analytics" class="nav-item w-full flex items-center p-4 rounded-2xl text-slate-500 gap-4"><i class="fa-solid fa-chart-pie text-lg w-6 text-center"></i> Analytics</button></nav>
            <div class="p-6 border-t border-slate-50 bg-slate-50/50"><div class="flex items-center gap-4 mb-4 bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><div class="w-10 h-10 rounded-full bg-brand-50 flex items-center justify-center text-brand-600 font-bold border border-brand-100"><i class="fa-solid fa-user"></i></div><div class="flex-1 min-w-0"><p class="text-xs text-slate-400 font-bold uppercase">Logged In</p><p class="text-sm font-bold text-slate-900 truncate" id="desk-user">User</p></div></div><button onclick="logout()" class="w-full py-3 text-xs font-bold text-red-500 hover:bg-red-50 rounded-xl transition uppercase tracking-wider flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button></div>
        </aside>
        
        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/80">
            <header class="lg:hidden h-16 bg-white/90 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-5 sticky top-0 z-30 shadow-sm">
                <div class="flex items-center gap-2.5"><div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white text-sm shadow-md"><i class="fa-solid fa-cube"></i></div><span class="font-bold text-lg text-slate-800">Titan</span></div>
                <div class="flex items-center gap-3"><div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200"><div class="w-5 h-5 rounded-full bg-slate-300 flex items-center justify-center"><i class="fa-solid fa-user text-[10px] text-white"></i></div><span class="text-xs font-bold text-slate-700 max-w-[80px] truncate" id="mob-user">User</span></div><button onclick="logout()" class="w-9 h-9 rounded-full bg-red-50 border border-red-100 flex items-center justify-center text-red-500 hover:bg-red-100 transition"><i class="fa-solid fa-power-off text-sm"></i></button></div>
            </header>
            
            <div class="flex-1 overflow-y-auto p-4 lg:p-10 pb-28 lg:pb-10 scroll-smooth" id="main-scroll">
                <div id="view-dashboard" class="max-w-7xl mx-auto space-y-8 animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 lg:gap-8">
                        <div class="glass-dark p-8 rounded-3xl relative overflow-hidden shadow-2xl shadow-brand-900/20 group"><div class="relative z-10"><p class="text-indigo-200 text-xs font-bold uppercase mb-1">Lifetime</p><h2 class="text-4xl font-bold text-white tracking-tight" id="stat-total">₹0</h2></div></div>
                        <div class="glass p-8 rounded-3xl border border-white shadow-sm"><p class="text-slate-400 text-xs font-bold uppercase mb-1">This Month</p><h2 class="text-3xl font-bold text-slate-800" id="stat-month">₹0</h2></div>
                        <div class="glass p-8 rounded-3xl border border-white shadow-sm"><p class="text-slate-400 text-xs font-bold uppercase mb-1">This Week</p><h2 class="text-3xl font-bold text-slate-800" id="stat-week">₹0</h2></div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-8">
                        <div class="xl:col-span-1 glass p-8 rounded-3xl shadow-sm border border-white sticky top-6">
                            <h3 class="font-bold text-slate-800 text-lg mb-6">New Transaction</h3>
                            <form onsubmit="addExpense(event)" class="space-y-6">
                                <div class="grid grid-cols-2 gap-4"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 pl-1">Date</label><input type="date" id="add-date" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-semibold"></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 pl-1">Amount</label><input type="number" id="add-amt" placeholder="0" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold text-slate-900"></div></div>
                                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 pl-1">Category</label><div id="cat-grid" class="grid grid-cols-3 gap-3"></div><input type="hidden" id="add-cat" value="Food"></div>
                                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 pl-1">Description</label><input type="text" id="add-desc" placeholder="e.g. Starbucks" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-medium"></div>
                                <button id="btn-add" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition shadow-xl mt-2">Add Transaction</button>
                            </form>
                        </div>
                        <div class="xl:col-span-2 glass rounded-3xl overflow-hidden flex flex-col h-full min-h-[500px] border border-white shadow-sm">
                            <div class="p-6 border-b border-slate-100 bg-white/50 backdrop-blur flex justify-between items-center sticky top-0 z-10"><h3 class="font-bold text-slate-800 text-lg">History</h3><button onclick="loadData()" class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-brand-600 hover:bg-brand-50 transition"><i class="fa-solid fa-arrows-rotate"></i></button></div>
                            <div class="flex-1 overflow-y-auto"><table class="w-full text-left text-sm border-collapse"><tbody id="table-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div id="view-analytics" class="hidden max-w-7xl mx-auto space-y-8 animate-fade-in">
                    <div class="glass p-6 rounded-3xl border border-white shadow-sm flex flex-col md:flex-row gap-6 justify-between items-end"><div class="w-full md:w-auto flex-1"><label class="text-xs font-bold text-slate-400 uppercase mb-3 block pl-1">Quick Filters</label><div class="flex bg-slate-100 p-1.5 rounded-2xl gap-1"><button onclick="setFilter('week')" class="flex-1 py-2.5 px-6 rounded-xl text-xs font-bold text-slate-500 hover:bg-white hover:shadow-sm">Week</button><button onclick="setFilter('month')" class="flex-1 py-2.5 px-6 rounded-xl text-xs font-bold text-slate-500 hover:bg-white hover:shadow-sm">Month</button><button onclick="setFilter('year')" class="flex-1 py-2.5 px-6 rounded-xl text-xs font-bold text-slate-500 hover:bg-white hover:shadow-sm">Year</button></div></div><div class="w-full md:w-auto"><label class="text-xs font-bold text-slate-400 uppercase mb-3 block pl-1">Custom Range</label><div class="flex items-center gap-3 bg-slate-50 border border-slate-200 p-2 pl-4 rounded-2xl"><input type="date" id="report-start" class="bg-transparent text-sm font-bold text-slate-700 w-28 cursor-pointer outline-none"><span class="text-slate-300 text-xs font-bold">TO</span><input type="date" id="report-end" class="bg-transparent text-sm font-bold text-slate-700 w-28 cursor-pointer outline-none"><button onclick="applyReport()" class="w-10 h-10 rounded-xl bg-brand-600 text-white flex items-center justify-center shadow-lg hover:bg-brand-700 transition"><i class="fa-solid fa-arrow-right"></i></button></div></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8"><div class="lg:col-span-1 glass p-8 rounded-3xl border border-white shadow-sm flex flex-col items-center justify-center relative min-h-[400px]"><h3 class="font-bold text-slate-800 w-full mb-6 text-lg">Distribution</h3><div class="w-full h-64 relative z-10"><canvas id="expenseChart"></canvas></div><div class="absolute inset-0 flex items-center justify-center pointer-events-none mt-10"><div class="text-center"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Selected</p><p class="text-3xl font-bold text-slate-800 tracking-tight" id="report-total">₹0</p></div></div></div><div class="lg:col-span-2 glass rounded-3xl border border-white shadow-sm overflow-hidden"><div class="p-6 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700 text-lg">Breakdown</h3></div><div class="p-8 space-y-6" id="category-list"></div></div></div>
                </div>
            </div>
            <nav class="lg:hidden h-24 bg-white/95 backdrop-blur border-t border-slate-200 flex justify-around items-center px-4 pb-6 z-40 fixed bottom-0 w-full shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                <button onclick="switchTab('dashboard')" id="mob-nav-dashboard" class="mob-nav-item active flex-1 flex flex-col items-center py-2 text-slate-400 relative"><i class="fa-solid fa-house text-xl mb-1.5"></i><span class="text-[10px] font-bold">Home</span></button>
                <div class="w-20 relative -mt-12"><button onclick="document.getElementById('add-desc').focus()" class="w-16 h-16 rounded-full bg-brand-600 text-white shadow-xl shadow-brand-500/40 flex items-center justify-center text-2xl transform active:scale-90 transition border-4 border-slate-50"><i class="fa-solid fa-plus"></i></button></div>
                <button onclick="switchTab('analytics')" id="mob-nav-analytics" class="mob-nav-item flex-1 flex flex-col items-center py-2 text-slate-400 relative"><i class="fa-solid fa-chart-pie text-xl mb-1.5"></i><span class="text-[10px] font-bold">Analytics</span></button>
            </nav>
        </main>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-[90] bg-slate-900/60 backdrop-blur-md flex items-end sm:items-center justify-center sm:p-4 transition-opacity">
        <div class="bg-white w-full sm:max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 shadow-2xl animate-fade-in relative">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 sm:hidden"></div>
            <h3 class="text-2xl font-bold text-slate-900 mb-6">Edit Entry</h3>
            <input type="hidden" id="edit-id"><input type="hidden" id="edit-user">
            <div class="space-y-5">
                <div class="flex gap-4"><input type="date" id="edit-date" class="w-1/2 p-4 border border-slate-200 rounded-2xl bg-slate-50 font-bold text-sm focus:ring-2 focus:ring-brand-500 outline-none"><input type="number" id="edit-amt" class="w-1/2 p-4 border border-slate-200 rounded-2xl bg-slate-50 font-bold text-slate-900 placeholder-slate-300 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Amount"></div>
                <select id="edit-cat" class="w-full p-4 border border-slate-200 rounded-2xl bg-slate-50 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-brand-500 outline-none"></select>
                <input type="text" id="edit-desc" class="w-full p-4 border border-slate-200 rounded-2xl bg-slate-50 text-sm font-medium focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Description">
            </div>
            <div class="flex gap-3 mt-8"><button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-500 bg-slate-100 rounded-2xl">Cancel</button><button onclick="submitEdit()" id="btn-save-edit" class="flex-1 py-4 font-bold text-white bg-brand-600 rounded-2xl">Save</button></div>
        </div>
    </div>

    <script>
        // ============================================
        // ⚠️ PASTE YOUR GOOGLE SCRIPT URL HERE ⚠️
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwoDzkAByNIRh4XxDAk-GLUv1c-QB5h99oGzKpNtryNqWEeD31zjw_47FWGcSkpgSgg/exec"; 
        // ============================================

        let currentUser = localStorage.getItem("expenseUser");
        let allTransactions = [];
        let adminSheetData = [];
        let adminHeaders = [];
        let adminCurrentRowIndex = -1;
        let currentAdminPass = "";
        let categories = ['Food', 'Fuel', 'Groceries', 'Shopping', 'Bills', 'Entertainment', 'Other'];
        
        const colors = { 'Food':'#f59e0b', 'Fuel':'#3b82f6', 'Groceries':'#10b981', 'Shopping':'#8b5cf6', 'Bills':'#ef4444', 'Entertainment':'#ec4899', 'Other':'#64748b' };
        const icons = { 'Food':'fa-burger', 'Fuel':'fa-gas-pump', 'Groceries':'fa-carrot', 'Shopping':'fa-bag-shopping', 'Bills':'fa-file-invoice', 'Entertainment':'fa-film', 'Other':'fa-tag' };

        window.onload = function() {
            document.getElementById('add-date').valueAsDate = new Date();
            renderCategoryButtons();
            if(currentUser) showApp();
        }

        // --- ADMIN SYSTEM ---
        function submitAdminLogin() {
            const pass = document.getElementById('admin-password').value;
            const btn = document.getElementById('btn-admin-login');
            btn.innerText = "..."; btn.disabled = true;
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "adminLogin", password: pass }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    currentAdminPass = pass;
                    // FIX: CLOSE MODAL IMMEDIATELY
                    document.getElementById('admin-login-modal').classList.add('hidden');
                    document.getElementById('auth-view').classList.add('hidden');
                    document.getElementById('admin-view').classList.remove('hidden');
                    loadSheetNames();
                } else showToast("Wrong Password", "error");
            }).finally(() => { btn.innerText = "Login"; btn.disabled = false; });
        }
        function logoutAdmin() { currentAdminPass=""; location.reload(); }
        function loadSheetNames() {
            fetch(`${API_URL}?action=getSheetNames`).then(res=>res.json()).then(json => {
                const sel = document.getElementById('admin-sheet-select'); sel.innerHTML = "";
                json.payload.forEach(name => { let opt = document.createElement('option'); opt.value = name; opt.innerText = name; sel.appendChild(opt); });
                loadAdminSheet();
            });
        }
        function loadAdminSheet() {
            const sheetName = document.getElementById('admin-sheet-select').value;
            document.getElementById('admin-tbody').innerHTML = '<tr><td colspan="10" class="p-8 text-center text-slate-400 animate-pulse">Fetching Data...</td></tr>';
            fetch(`${API_URL}?action=getAdminData&sheetName=${sheetName}`).then(res => res.json()).then(json => {
                const data = json.payload.data; adminHeaders = data[0]; adminSheetData = data.slice(1); renderAdminTable();
            });
        }
        function renderAdminTable() {
            const thead = document.getElementById('admin-thead'); const tbody = document.getElementById('admin-tbody');
            thead.innerHTML = ""; tbody.innerHTML = "";
            let headRow = "<tr>"; adminHeaders.forEach(h => headRow += `<th class="p-4 bg-slate-50 border-b border-slate-200 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">${h}</th>`); headRow += `<th class="p-4 bg-slate-50 border-b border-slate-200 text-center text-xs font-bold text-slate-500 uppercase">Actions</th></tr>`; thead.innerHTML = headRow;
            if(adminSheetData.length === 0) { tbody.innerHTML = `<tr><td colspan="${adminHeaders.length+1}" class="p-10 text-center text-slate-400">Empty Sheet</td></tr>`; return; }
            adminSheetData.forEach((row, index) => {
                let tr = `<tr class="border-b border-slate-100 hover:bg-slate-50 transition">`;
                row.forEach(cell => tr += `<td class="p-4 whitespace-nowrap text-sm text-slate-600">${cell}</td>`);
                tr += `<td class="p-4 text-center flex gap-2 justify-center"><button onclick="openAdminEdit(${index})" class="text-brand-600 bg-brand-50 p-2 rounded-lg hover:bg-brand-100 transition"><i class="fa-solid fa-pen"></i></button><button onclick="adminDelete(${index})" class="text-red-500 bg-red-50 p-2 rounded-lg hover:bg-red-100 transition"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                tbody.innerHTML += tr;
            });
        }
        function openAdminEdit(index) { adminCurrentRowIndex = index; const rowData = adminSheetData[index]; buildAdminForm(rowData, "Edit Row"); }
        function openAdminAdd() { adminCurrentRowIndex = -1; buildAdminForm(new Array(adminHeaders.length).fill(""), "Add New Row"); }
        function buildAdminForm(values, title) {
            const container = document.getElementById('admin-modal-fields'); container.innerHTML = "";
            document.getElementById('admin-modal-title').innerText = title;
            adminHeaders.forEach((header, i) => {
                let div = document.createElement('div');
                div.innerHTML = `<label class="block text-xs font-bold text-slate-500 uppercase mb-2 pl-1">${header}</label><input type="text" id="admin-field-${i}" value="${values[i]}" class="w-full p-3.5 border border-slate-200 rounded-2xl bg-slate-50 font-medium focus:ring-2 focus:ring-brand-500 outline-none transition text-sm">`;
                container.appendChild(div);
            });
            document.getElementById('admin-modal').classList.remove('hidden');
        }
        function submitAdminForm() {
            const sheetName = document.getElementById('admin-sheet-select').value;
            const newRow = adminHeaders.map((_, i) => document.getElementById(`admin-field-${i}`).value);
            const action = adminCurrentRowIndex === -1 ? "adminAdd" : "adminEdit";
            const payload = { action: action, sheetName: sheetName, row: newRow, rowIndex: adminCurrentRowIndex };
            fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }).then(res => res.json()).then(data => {
                if(data.status === 'success') { showToast(adminCurrentRowIndex === -1 ? "Added" : "Updated"); document.getElementById('admin-modal').classList.add('hidden'); loadAdminSheet(); } else showToast("Error", "error");
            });
        }
        function adminDelete(index) {
            if(!confirm("Delete this row?")) return;
            const sheetName = document.getElementById('admin-sheet-select').value;
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "adminDelete", sheetName: sheetName, rowIndex: index }) }).then(res => res.json()).then(data => { if(data.status === 'success') { showToast("Deleted"); loadAdminSheet(); } });
        }

        // --- USER CORE ---
        function renderCategoryButtons() { 
            const grid = document.getElementById('cat-grid'); grid.innerHTML = ''; 
            categories.forEach(cat => { 
                const btn = document.createElement('button'); btn.type = 'button'; 
                btn.className = 'cat-btn p-3 rounded-2xl border border-slate-200 text-xs font-bold text-slate-500 hover:bg-slate-50 transition text-center truncate bg-white shadow-sm'; 
                btn.innerText = cat; btn.onclick = () => selectCat(btn, cat); 
                if(cat === 'Food') { btn.classList.add('bg-brand-50', 'text-brand-600', 'border-brand-200', 'ring-2', 'ring-brand-100'); btn.classList.remove('text-slate-500', 'border-slate-200', 'bg-white'); } 
                grid.appendChild(btn); 
            }); 
            const addBtn = document.createElement('button'); addBtn.type = 'button'; 
            addBtn.className = 'p-3 rounded-2xl border border-dashed border-slate-300 text-xs font-bold text-slate-400 hover:bg-slate-50 transition flex items-center justify-center gap-1'; 
            addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> New'; addBtn.onclick = () => document.getElementById('cat-modal').classList.remove('hidden'); 
            grid.appendChild(addBtn); 
            const editSelect = document.getElementById('edit-cat'); editSelect.innerHTML = ''; 
            categories.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.innerText = cat; editSelect.appendChild(opt); }); 
        }
        function selectCat(btn, val) { 
            document.querySelectorAll('.cat-btn').forEach(b => { b.className = 'cat-btn p-3 rounded-2xl border border-slate-200 text-xs font-bold text-slate-500 hover:bg-slate-50 transition text-center truncate bg-white shadow-sm'; }); 
            btn.className = 'cat-btn p-3 rounded-2xl border border-brand-200 bg-brand-50 text-xs font-bold text-brand-600 transition text-center truncate ring-2 ring-brand-100'; 
            document.getElementById('add-cat').value = val; 
        }
        
        function loadData() { fetch(`${API_URL}?action=getData&user=${currentUser}`).then(res => res.json()).then(json => { if(json.status === 'success') { allTransactions = json.payload.history; updateStats(json.payload.stats); if(json.payload.categories) { json.payload.categories.forEach(c => { if(!categories.includes(c)) categories.push(c); }); renderCategoryButtons(); } renderTable(allTransactions); } }); }
        
        function addExpense(e) { 
            e.preventDefault(); const btn = document.getElementById('btn-add'); btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; 
            const form = { action: "add", user: currentUser, date: document.getElementById('add-date').value, category: document.getElementById('add-cat').value, description: document.getElementById('add-desc').value, amount: document.getElementById('add-amt').value }; 
            fetch(API_URL, { method: "POST", body: JSON.stringify(form) }).then(res => res.json()).then(data => { if(data.status === 'success') { showToast("Added Successfully"); document.getElementById('add-desc').value=''; document.getElementById('add-amt').value=''; loadData(); } }).finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check"></i> Add Transaction'; }); 
        }
        
        function saveCategory() { const name = document.getElementById('new-cat-name').value.trim(); if(!name) return; const btn = document.getElementById('btn-save-cat'); btn.innerText = '...'; btn.disabled = true; fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "addCategory", user: currentUser, category: name }) }).then(res => res.json()).then(data => { if(data.status === 'success') { document.getElementById('cat-modal').classList.add('hidden'); document.getElementById('new-cat-name').value = ''; categories.push(name); renderCategoryButtons(); showToast("Category Added"); } else showToast(data.payload, 'error'); }).finally(() => { btn.innerText = 'Create Category'; btn.disabled = false; }); }

        function renderTable(data) { const tbody = document.getElementById('table-body'); tbody.innerHTML = ""; const empty = `<div class="p-10 text-center"><i class="fa-solid fa-receipt text-3xl text-slate-300 mb-2"></i><p class="text-slate-400 font-bold mt-2">No Transactions</p></div>`; if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="4">${empty}</td></tr>`; return; } data.forEach(t => { 
            const dateObj = new Date(t.timestamp);
            const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            // NEW: Show time if it was "Today" logic
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const color = colors[t.category] || '#64748b'; const icon = icons[t.category] || 'fa-tag'; 
            tbody.innerHTML += `<tr class="group hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><td class="p-6"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-brand-50 group-hover:text-brand-600 transition shadow-sm border border-slate-100"><i class="fa-solid ${icon} text-lg"></i></div><div><p class="font-bold text-slate-800 text-sm mb-0.5">${t.desc}</p><p class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">${dateStr} • ${timeStr} • <span class="text-brand-600">${t.category}</span></p></div></div></td><td class="p-6 text-right"><span class="font-bold text-slate-800 block text-base mb-1">-₹${t.amount.toLocaleString()}</span><div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openEditModal('${t.id}', false)" class="text-brand-600 hover:bg-brand-50 p-1.5 rounded-lg transition"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('${t.id}', false)" class="text-slate-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition"><i class="fa-solid fa-trash"></i></button></div></td></tr>`; }); 
        }

        // --- SHARED EDIT/DELETE ---
        function deleteItem(id, isAdmin) { if(!confirm("Are you sure?")) return; showToast("Deleting...","info"); let payload = { action: "delete", id: id }; if (isAdmin) { payload.user = ""; payload.adminKey = currentAdminPass; } else { payload.user = currentUser; } fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }).then(res => res.json()).then(data => { if(data.status === 'success') { showToast("Deleted"); if(isAdmin) loadAdminData(); else loadData(); } else showToast("Delete Failed", "error"); }); }
        function openEditModal(id, isAdmin) { const item = allTransactions.find(t => t.id === id); if(!item) return; document.getElementById('edit-id').value = id; document.getElementById('edit-user').value = isAdmin ? item.user : currentUser; document.getElementById('edit-date').value = new Date(item.timestamp).toISOString().split('T')[0]; document.getElementById('edit-cat').value = item.category; document.getElementById('edit-desc').value = item.desc; document.getElementById('edit-amt').value = item.amount; document.getElementById('btn-save-edit').setAttribute('data-is-admin', isAdmin); document.getElementById('edit-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function submitEdit() { const btn = document.getElementById('btn-save-edit'); const isAdmin = btn.getAttribute('data-is-admin') === 'true'; btn.disabled = true; btn.innerText = "Saving..."; const form = { action: "edit", id: document.getElementById('edit-id').value, user: document.getElementById('edit-user').value, date: document.getElementById('edit-date').value, category: document.getElementById('edit-cat').value, description: document.getElementById('edit-desc').value, amount: document.getElementById('edit-amt').value }; if (isAdmin) form.adminKey = currentAdminPass; fetch(API_URL, { method: "POST", body: JSON.stringify(form) }).then(res => res.json()).then(data => { if(data.status === 'success') { showToast("Updated"); closeModal(); if(isAdmin) loadAdminData(); else loadData(); } else showToast("Update Failed", "error"); }).finally(() => { btn.disabled = false; btn.innerText = "Save Changes"; }); }

        // --- AUTH & NAV ---
        function switchTab(tab) { document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active')); if(document.getElementById(`desk-nav-${tab}`)) document.getElementById(`desk-nav-${tab}`).classList.add('active'); document.querySelectorAll('.mob-nav-item').forEach(el => { el.classList.remove('active', 'text-brand-600'); el.classList.add('text-slate-400'); }); if(document.getElementById(`mob-nav-${tab}`)) { const mob = document.getElementById(`mob-nav-${tab}`); mob.classList.add('active', 'text-brand-600'); mob.classList.remove('text-slate-400'); } document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-analytics').classList.add('hidden'); document.getElementById(`view-${tab}`).classList.remove('hidden'); if(tab === 'analytics') setFilter('month'); }
        function toggleAuth(mode) { authMode = mode; const loginBtn=document.getElementById('tab-login'); const regBtn=document.getElementById('tab-reg'); const authBtn=document.getElementById('btn-auth'); if(mode==='login'){ loginBtn.className='flex-1 bg-white shadow-sm py-3 rounded-xl font-bold text-slate-800 transition text-sm'; regBtn.className='flex-1 text-slate-500 py-3 rounded-xl font-bold transition text-sm hover:text-slate-700'; authBtn.innerText="Sign In"; } else { regBtn.className='flex-1 bg-white shadow-sm py-3 rounded-xl font-bold text-slate-800 transition text-sm'; loginBtn.className='flex-1 text-slate-500 py-3 rounded-xl font-bold transition text-sm hover:text-slate-700'; authBtn.innerText="Create Account"; } }
        function handleAuth(e) { e.preventDefault(); const btn=document.getElementById('btn-auth'); const u=document.getElementById('auth-user').value; const p=document.getElementById('auth-pass').value; btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>'; fetch(API_URL, {method:"POST", body:JSON.stringify({action:authMode, username:u, password:p})}).then(res=>res.json()).then(data=>{ if(data.status==='success'){ if(authMode==='login'){ currentUser=data.payload.username; localStorage.setItem("expenseUser",currentUser); showApp(); } else { showToast("Registered! Please login."); toggleAuth('login'); } } else showToast(data.payload,'error'); }).finally(()=>{ btn.disabled=false; btn.innerText=authMode==='login'?"Sign In":"Create Account"; }); }
        function showApp() { document.getElementById('auth-view').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); document.getElementById('desk-user').innerText=currentUser; document.getElementById('mob-user').innerText=currentUser; loadData(); }
        function logout() { localStorage.removeItem("expenseUser"); location.reload(); }
        function updateStats(s) { document.getElementById('stat-week').innerText="₹"+s.weekly.toLocaleString(); document.getElementById('stat-month').innerText="₹"+s.monthly.toLocaleString(); document.getElementById('stat-total').innerText="₹"+s.total.toLocaleString(); }
        function setFilter(type) { const now=new Date(); const s=document.getElementById('report-start'); const e=document.getElementById('report-end'); e.valueAsDate=now; if(type==='week'){const d=new Date(); d.setDate(now.getDate()-7); s.valueAsDate=d;} else if(type==='month'){s.valueAsDate=new Date(now.getFullYear(), now.getMonth(), 1);} else if(type==='year'){s.valueAsDate=new Date(now.getFullYear(), 0, 1);} applyReport(); }
        function applyReport() { const start = new Date(document.getElementById('report-start').value || 0); const end = new Date(document.getElementById('report-end').value || '2100-01-01'); end.setHours(23,59,59); const filtered = allTransactions.filter(t => { const d = new Date(t.timestamp); return d >= start && d <= end; }); const breakdown = {}; let total = 0; filtered.forEach(t => { breakdown[t.category] = (breakdown[t.category] || 0) + t.amount; total += t.amount; }); document.getElementById('report-total').innerText = "₹" + total.toLocaleString(); renderChart(breakdown); renderCategoryList(breakdown, total); }
        function renderChart(data) { const ctx=document.getElementById('expenseChart').getContext('2d'); if(chartInstance)chartInstance.destroy(); chartInstance=new Chart(ctx, {type:'doughnut', data:{labels:Object.keys(data), datasets:[{data:Object.values(data), backgroundColor:Object.keys(data).map(k=>colors[k]||'#6366f1'), borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, cutout:'80%', plugins:{legend:{display:false}}}}); }
        function renderCategoryList(data, total) { const c=document.getElementById('category-list'); c.innerHTML=""; Object.keys(data).sort((a,b)=>data[b]-data[a]).forEach(cat=>{ const amt=data[cat]; const pct=total>0?Math.round((amt/total)*100):0; const color=colors[cat]||'#6366f1'; const icon=icons[cat]||'fa-tag'; c.innerHTML+=`<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-md shadow-brand-500/20" style="background-color:${color}"><i class="fa-solid ${icon}"></i></div><div class="flex-1"><div class="flex justify-between text-sm mb-2"><span class="font-bold text-slate-800">${cat}</span><span class="font-bold text-slate-900">₹${amt.toLocaleString()} <span class="text-slate-400 font-medium ml-1">(${pct}%)</span></span></div><div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div class="h-2 rounded-full" style="width:${pct}%; background-color:${color}"></div></div></div></div>`; }); }
        function showToast(msg, type='success') { const el=document.createElement('div'); el.className=`toast-enter p-4 rounded-2xl shadow-xl flex items-center gap-3 text-sm font-bold text-white pointer-events-auto backdrop-blur-md ${type==='success'?'bg-emerald-500/90':'bg-red-500/90'}`; el.innerHTML=`<i class="fa-solid ${type==='success'?'fa-circle-check':'fa-triangle-exclamation'}"></i> ${msg}`; document.getElementById('toast-container').appendChild(el); setTimeout(()=>{el.style.opacity='0'; setTimeout(()=>el.remove(),300)},3000); }
    </script>
</body>
</html>