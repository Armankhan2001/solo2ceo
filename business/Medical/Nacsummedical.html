<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nacsum Biotech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Manrope', sans-serif; background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
        .spinner-dark { border: 3px solid rgba(13, 148, 136, 0.2); border-top: 3px solid #0d9488; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-section { display: none !important; }
        .modal-overlay { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .chat-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-gray-800 antialiased pb-24 md:pb-0">

    <div id="toastBox" class="fixed top-5 right-5 z-[200] flex flex-col gap-3 pointer-events-none"></div>

    <div id="aiChatWindow" class="hidden fixed inset-0 z-[150] md:inset-auto md:bottom-24 md:right-6 md:w-96 md:h-[600px] bg-white md:rounded-2xl shadow-2xl flex flex-col overflow-hidden chat-slide-up">
        <div class="bg-gray-900 p-4 flex justify-between items-center text-white shrink-0">
            <div class="flex items-center gap-3">
                <div class="bg-teal-500 w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-teal-500/50">
                    <i class="fas fa-user-md text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg leading-tight">Nacsum Consultant</h3>
                    <p class="text-[10px] text-gray-300 opacity-90">AI Powered Assistance</p>
                </div>
            </div>
            <button onclick="toggleAiChat()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition"><i class="fas fa-times text-lg"></i></button>
        </div>
        
        <div id="aiMessages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50 scroll-smooth pb-20 md:pb-4">
    <div class="flex gap-3 fade-in">
        <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600 text-xs shadow-sm">
            <i class="fas fa-user-md"></i>
        </div>
        <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 border border-gray-100">
            <p class="font-bold text-gray-800 mb-1">Hello! ðŸ‘‹</p>
            <p class="mb-3">I am your Nacsum Medical Consultant. You can ask me about:</p>
            <ul class="list-disc ml-4 space-y-1 text-xs text-gray-500 mb-3">
                <li>Medicine availability & prices</li>
                <li>Common symptom remedies</li>
                <li>Health tips</li>
            </ul>
            <div class="mt-3 pt-3 border-t border-gray-100 text-[10px] text-gray-400 leading-tight">
                <i class="fas fa-exclamation-circle text-teal-500 mr-1"></i> 
                <b>Note:</b> Consult a Doctor for serious conditions.<br>
                <br>
                <small>Or Call Us ! On Below Numbers</small>
                <span class="block mt-1">
                    <i class="fas fa-phone-alt mr-1"></i> +918850102255, +918268400523
                </span>
            </div>
        </div>
    </div>
</div>

        <div id="aiTyping" class="hidden px-4 pb-2 bg-gray-50">
            <div class="flex gap-1 ml-11 bg-gray-200 w-fit px-3 py-2 rounded-xl rounded-tl-none">
                <div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
            </div>
        </div>
        
        <div class="p-3 bg-white border-t border-gray-100 flex gap-2 shrink-0">
            <input type="text" id="aiInput" onkeydown="handleAiEnter(event)" placeholder="Ask health question..." class="flex-grow bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 transition">
            <button onclick="sendAiMessage()" class="bg-teal-600 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-teal-700 transition shadow-md active:scale-95"><i class="fas fa-paper-plane text-sm"></i></button>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-[90] hidden md:block">
        <button onclick="toggleAiChat()" class="bg-gray-900 hover:bg-teal-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 transform hover:scale-110 group ring-4 ring-white">
            <i class="fas fa-comment-medical text-2xl group-hover:animate-pulse"></i>
        </button>
    </div>

    <div id="app-public" class="transition-opacity duration-300 min-h-screen flex flex-col">
        
        <nav class="bg-white/95 backdrop-blur-md sticky top-0 z-40 border-b border-gray-100 shadow-sm">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer select-none" onclick="showPublicHome()">
    <div class="bg-gradient-to-br from-teal-500 to-emerald-600 text-white w-10 h-10 rounded-2xl flex items-center justify-center shadow-lg shadow-teal-500/30">
        <i class="fas fa-hand-holding-heart text-lg"></i>
    </div>

    <div class="leading-tight">
        <span class="text-xl font-extrabold tracking-tight text-gray-800">
            Nacsum <span class="text-teal-600">Biotech</span>
        </span>
        <div class="text-[11px] text-gray-500 font-medium tracking-wide">
            Science with Humanity
        </div>
    </div>
</div>

                
                <div class="hidden md:flex items-center gap-6">
                    <button onclick="showPublicHome()" class="font-medium text-gray-600 hover:text-teal-600 transition">Home</button>
                    <button onclick="showSection('about')" class="font-medium text-gray-600 hover:text-teal-600 transition">About</button>
                    <button onclick="showSection('contact')" class="font-medium text-gray-600 hover:text-teal-600 transition">Contact</button>
                    <button onclick="showSection('myorders');loadCustomerOrders()" class="font-medium text-gray-600 hover:text-teal-600 transition">Orders</button>
                    <div id="authContainer" class="flex items-center gap-3"></div>
                </div>

                <div class="md:hidden flex items-center gap-3">
                     <button onclick="openCart()" class="relative text-gray-800 p-2 bg-gray-50 rounded-full">
                        <i class="fas fa-shopping-bag text-lg"></i>
                        <span id="cartCountMob" class="absolute -top-1 -right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center font-bold hidden border-2 border-white">0</span>
                    </button>
                </div>
            </div>
        </nav>

        <section id="view-home" class="container mx-auto px-4 mt-4 fade-in pb-24">
            <div class="bg-gray-900 rounded-3xl p-6 md:p-10 text-white shadow-xl mb-8 relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-3xl md:text-5xl font-extrabold mb-3 leading-tight">Your Health, <br><span class="text-teal-400">Our Priority.</span></h1>
                    <p class="text-gray-400 mb-6 text-sm md:text-base">Search Medicines by Store, City or Name.</p>
                    
                    <div class="flex flex-col md:flex-row gap-2">
                        <div class="bg-white rounded-xl md:rounded-l-xl md:rounded-r-none shadow-lg flex items-center p-1.5 min-w-[140px]">
                            <i class="fas fa-map-marker-alt text-teal-600 ml-3 text-sm"></i>
                            <select id="cityFilter" onchange="searchPublic()" class="w-full bg-transparent p-2 text-sm font-bold text-gray-800 outline-none cursor-pointer">
                                <option value="All">All Cities</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-xl md:rounded-r-xl md:rounded-l-none shadow-lg flex items-center p-1.5 flex-grow transform transition-all focus-within:ring-4 ring-teal-500/30">
                            <i class="fas fa-search text-gray-400 ml-3 text-sm"></i>
                            <input type="text" id="publicSearch" onkeyup="searchPublic()" placeholder="Search Medicine or Store Name..." class="flex-grow p-3 outline-none text-gray-800 placeholder-gray-400 font-medium bg-transparent text-sm">
                        </div>
                    </div>

                </div>
                <div class="absolute top-0 right-0 w-64 h-64 bg-teal-600 rounded-full blur-[100px] opacity-30 translate-x-1/3 -translate-y-1/3"></div>
            </div>

            <div class="mb-8">
                <div class="flex gap-4 overflow-x-auto pb-4 no-scrollbar scroll-smooth" id="catList">
                    <!-- ALL -->
<button onclick="filterCat('All')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-teal-600 flex items-center justify-center text-white shadow-lg shadow-teal-500/30 transition transform group-active:scale-95">
        <i class="fas fa-th text-xl"></i>
    </div>
    <span class="text-xs font-bold text-gray-700">All</span>
</button>

<!-- TABLET -->
<button onclick="filterCat('Tablet')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-teal-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-pills text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Tablet</span>
</button>

<!-- CAPSULE -->
<button onclick="filterCat('Capsule')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-indigo-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-capsules text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Capsule</span>
</button>

<!-- SYRUP -->
<button onclick="filterCat('Syrup')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-orange-400 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-wine-bottle text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Syrup</span>
</button>

<!-- INJECTION -->
<button onclick="filterCat('Injection')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-blue-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-syringe text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Injection</span>
</button>

<!-- DROPS -->
<button onclick="filterCat('Drops')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-cyan-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-tint text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Drops</span>
</button>

<!-- CREAM -->
<button onclick="filterCat('Cream')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-pink-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-hand-holding-medical text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Cream</span>
</button>

<!-- INHALER -->
<button onclick="filterCat('Inhaler')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-purple-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-lungs text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Inhaler</span>
</button>

<!-- SURGICAL -->
<button onclick="filterCat('Surgical')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-red-600 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-procedures text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Surgical</span>
</button>



<!-- AYURVEDIC -->
<button onclick="filterCat('Ayurvedic')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-green-600 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-leaf text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Ayurvedic</span>
</button>

<!-- BABY CARE -->
<button onclick="filterCat('Baby Care')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-yellow-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-baby text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Baby Care</span>
</button>

<!-- PERSONAL CARE -->
<button onclick="filterCat('Personal Care')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-rose-500 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-pump-soap text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Personal Care</span>
</button>

<!-- SUPPLEMENTS -->
<button onclick="filterCat('Supplements')" class="flex-shrink-0 flex flex-col items-center gap-2 min-w-[72px] group">
    <div class="w-16 h-16 rounded-2xl bg-white border border-gray-100 flex items-center justify-center text-emerald-600 shadow-sm transition transform group-active:scale-95">
        <i class="fas fa-dumbbell text-2xl"></i>
    </div>
    <span class="text-xs font-medium text-gray-600">Supplements</span>
</button>

                    
                </div>
            </div>

            <h3 class="font-bold text-xl mb-4 text-gray-800 px-1">Nacsum Store</h3>
            <div id="publicGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-6"></div>
            <div id="mainLoader" class="text-center py-20 hidden"><div class="spinner spinner-dark w-10 h-10"></div><p class="text-gray-400 mt-3 text-sm">Loading Medicines...</p></div>
        </section>

        <section id="view-about" class="container mx-auto px-4 mt-6 fade-in pb-24 hidden-section">
            
            <div class="relative bg-gradient-to-br from-teal-900 to-black rounded-3xl p-8 md:p-16 text-white mb-10 overflow-hidden shadow-2xl">
                <div class="relative z-10 max-w-2xl">
                    <span class="bg-teal-500/20 text-teal-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest border border-teal-500/30 mb-4 inline-block">Our Mission</span>
                    <h1 class="text-3xl md:text-5xl font-extrabold mb-6 leading-tight">Bridging the Gap in <span class="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-green-400">Healthcare.</span></h1>
                    <p class="text-gray-300 text-base md:text-lg leading-relaxed mb-8">
                        Nacsum Biotech is not just a platform; it's a movement to make essential medicines accessible to every corner of India instantly. We connect patients directly with trusted local stockists.
                    </p>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="showSection('contact')" class="bg-teal-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-teal-600 transition shadow-lg shadow-teal-500/25 text-sm md:text-base">Partner With Us</button>
                        <button onclick="showPublicHome()" class="bg-white/10 backdrop-blur-md border border-white/20 text-white px-6 py-3 rounded-xl font-bold hover:bg-white/20 transition text-sm md:text-base">Explore Store</button>
                    </div>
                </div>
                <div class="absolute -top-24 -right-24 w-96 h-96 bg-teal-500 rounded-full blur-[120px] opacity-20"></div>
                <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-500 rounded-full blur-[100px] opacity-10"></div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-10">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <h3 class="text-2xl md:text-3xl font-extrabold text-teal-600 mb-1">500+</h3>
                    <p class="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Pharmacies</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <h3 class="text-2xl md:text-3xl font-extrabold text-blue-600 mb-1">10k+</h3>
                    <p class="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Medicines</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <h3 class="text-2xl md:text-3xl font-extrabold text-purple-600 mb-1">24/7</h3>
                    <p class="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">AI Support</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <h3 class="text-2xl md:text-3xl font-extrabold text-orange-500 mb-1">30m</h3>
                    <p class="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-wider">Avg Delivery</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-12">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100">
                    <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center text-teal-600 text-xl mb-6"><i class="fas fa-shield-alt"></i></div>
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Why Choose Nacsum?</h3>
                    <p class="text-gray-600 leading-relaxed mb-6 text-sm md:text-base">
                        Unlike traditional e-pharmacies that ship from distant warehouses, Nacsum localizes the inventory. We empower your neighborhood pharmacy to serve you digitally, ensuring <b class="text-gray-800">faster delivery</b> and <b class="text-gray-800">genuine products</b> you can trust.
                    </p>
                    <ul class="space-y-3">
                        <li class="flex items-center gap-3 text-sm text-gray-600"><i class="fas fa-check-circle text-green-500"></i> Verified Medical Partners</li>
                        <li class="flex items-center gap-3 text-sm text-gray-600"><i class="fas fa-check-circle text-green-500"></i> Real-time Stock Updates</li>
                        <li class="flex items-center gap-3 text-sm text-gray-600"><i class="fas fa-check-circle text-green-500"></i> Secure Digital Payments</li>
                    </ul>
                </div>

                <div class="bg-gray-900 text-white p-6 md:p-8 rounded-3xl shadow-lg relative overflow-hidden flex flex-col justify-between">
                    <div class="relative z-10">
                        <h3 class="text-xl md:text-2xl font-bold mb-4">Our Vision</h3>
                        <p class="text-gray-400 leading-relaxed text-sm md:text-base">
                            To create a seamless healthcare ecosystem where technology and trust go hand in hand. We envision a future where no patient has to wait or travel for life-saving medication.
                        </p>
                    </div>
                    <div class="mt-8 relative z-10 border-t border-gray-700 pt-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center font-bold text-xl">NB</div>
                            <div>
                                <p class="font-bold text-white text-sm">Leadership Team</p>
                                <p class="text-[10px] text-teal-400 uppercase tracking-widest">Nacsum Biotech</p>
                            </div>
                        </div>
                    </div>
                    <i class="fas fa-globe-asia text-9xl absolute -bottom-10 -right-10 text-white opacity-5"></i>
                </div>
            </div>

            <div class="text-center border-t border-gray-200 pt-10">
                <p class="text-xs text-gray-400 mb-1 uppercase tracking-widest">Registered Office</p>
                <p class="font-bold text-gray-800">Nacsum Biotech Pvt Ltd.</p>
                <p class="text-sm text-gray-500">Mumbai, Maharashtra, India</p>
            </div>

        </section>
        <section id="view-contact" class="container mx-auto px-4 mt-6 fade-in pb-24 hidden-section">
            
            <div class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">Get in <span class="text-teal-600">Touch</span></h1>
                <p class="text-gray-500 text-sm md:text-base max-w-lg mx-auto">We are here to help. Reach out to us for orders, partnership inquiries, or general support.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition group">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center text-teal-600 text-xl group-hover:scale-110 transition">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Manager Support</h3>
                            <p class="text-xs text-gray-400 uppercase tracking-wide">Business & Escalations</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <a href="tel:+918850102255" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-teal-50 hover:text-teal-700 transition">
                            <i class="fas fa-phone-alt text-sm"></i>
                            <span class="font-bold font-mono">+91 88501 02255</span>
                        </a>
                        <a href="tel:+918268400523" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-teal-50 hover:text-teal-700 transition">
                            <i class="fas fa-phone-alt text-sm"></i>
                            <span class="font-bold font-mono">+91 82684 00523</span>
                        </a>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition group">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-xl group-hover:scale-110 transition">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Customer Support</h3>
                            <p class="text-xs text-gray-400 uppercase tracking-wide">Order & Delivery Queries</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <a href="tel:+917021360582" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-blue-50 hover:text-blue-700 transition">
                            <i class="fas fa-phone-alt text-sm"></i>
                            <span class="font-bold font-mono">+91 70213 60582</span>
                        </a>
                        <div class="p-3 text-xs text-gray-400 text-center">
                            Available: 9:00 AM - 9:00 PM (Mon-Sat)
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white p-6 rounded-2xl shadow-lg md:col-span-2 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white text-xl backdrop-blur-sm">
                            <i class="fas fa-at"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Connect Digitally</h3>
                            <p class="text-xs text-gray-400">Email or DM us anytime.</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <a href="mailto:nacsumbiotech@gmail.com" class="flex items-center justify-center gap-2 bg-white text-gray-900 px-5 py-3 rounded-xl font-bold hover:bg-gray-100 transition shadow-lg">
                            <i class="fas fa-envelope text-red-500"></i> Email Us
                        </a>
                        <a href="https://instagram.com/Nacsumbiotech" target="_blank" class="flex items-center justify-center gap-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white px-5 py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                            <i class="fab fa-instagram"></i> @Nacsumbiotech
                        </a>
                    </div>
                </div>

            </div>

            <div class="mt-10 bg-teal-50 border border-teal-100 rounded-2xl p-6 text-center max-w-4xl mx-auto">
                <h4 class="text-teal-800 font-bold mb-2">Own a Pharmacy?</h4>
                <p class="text-sm text-teal-600 mb-4">Join our network and start selling online today.</p>
                <button onclick="openAuth('partner')" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-teal-700 transition">Register as Partner</button>
            </div>

        </section>

        <section id="view-myorders" class="container mx-auto px-4 py-6 hidden-section fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">My Orders</h2>
            <div class="flex gap-4 border-b border-gray-200 mb-6 sticky top-16 bg-[#f0f2f5] z-10 pt-2">
                <button onclick="filterMyOrders('Current')" id="tabMy-Current" class="pb-3 border-b-2 border-teal-600 font-bold text-teal-600 px-4 transition">Active</button>
                <button onclick="filterMyOrders('History')" id="tabMy-History" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-teal-600 px-4 transition">History</button>
            </div>
            <div id="myOrdersList" class="space-y-4 max-w-3xl mx-auto pb-24"></div>
        </section>
    </div>

    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center h-20 z-[100] shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pb-safe rounded-t-3xl">
        <button onclick="showPublicHome()" class="flex flex-col items-center gap-1 w-full h-full justify-center text-teal-600 pt-2">
            <i class="fas fa-home text-xl"></i>
            <span class="text-[10px] font-bold">Home</span>
        </button>
        <button onclick="showSection('myorders');loadCustomerOrders()" class="flex flex-col items-center gap-1 w-full h-full justify-center text-gray-400 hover:text-teal-600 transition pt-2">
            <i class="fas fa-clipboard-list text-xl"></i>
            <span class="text-[10px] font-bold">Orders</span>
        </button>
        <div class="relative -top-6">
            <button onclick="toggleAiChat()" class="bg-gray-900 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-xl shadow-gray-900/40 border-4 border-white transform active:scale-95 transition">
                <i class="fas fa-comment-medical text-2xl"></i>
            </button>
        </div>
        <button onclick="checkPartnerAndRedirect()" class="flex flex-col items-center gap-1 w-full h-full justify-center text-gray-400 hover:text-teal-600 transition pt-2">
            <i class="fas fa-store text-xl"></i>
            <span class="text-[10px] font-bold">Partner</span>
        </button>
        <button onclick="openAuth('login')" id="mobNavProfile" class="flex flex-col items-center gap-1 w-full h-full justify-center text-gray-400 hover:text-teal-600 transition pt-2">
            <i class="fas fa-user text-xl"></i>
            <span class="text-[10px] font-bold">Login</span>
        </button>
    </div>

    <div id="app-admin" class="hidden-section fixed inset-0 z-[150] bg-[#f8f9fa] flex h-screen overflow-hidden">
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-60 z-20 hidden md:hidden transition-opacity"></div>
        <aside id="adminSidebar" class="fixed inset-y-0 left-0 w-72 bg-white shadow-2xl transform -translate-x-full md:translate-x-0 md:static md:shadow-xl flex flex-col z-30 transition-transform duration-300 ease-in-out border-r border-gray-100">
            <div class="p-8 border-b border-gray-100 flex justify-between items-start bg-teal-50">
                <div id="adminProfileInfo"></div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                <button onclick="switchAdminView('products');toggleSidebar()" class="w-full text-left p-4 rounded-xl bg-teal-600 text-white font-bold shadow-lg shadow-teal-500/30 transition flex items-center gap-3"><i class="fas fa-box text-lg"></i> Inventory</button>
                <button onclick="switchAdminView('orders');toggleSidebar()" class="w-full text-left p-4 rounded-xl text-gray-600 hover:bg-gray-100 font-medium transition flex items-center gap-3"><i class="fas fa-clipboard-check text-lg"></i> Orders</button>
                <div class="mt-8 pt-8 border-t border-gray-100">
                    <button onclick="switchToHome()" class="w-full text-left p-3 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-xl font-bold transition flex items-center gap-2 mb-2"><i class="fas fa-arrow-left"></i> Customer View</button>
                    <button onclick="logoutPartner()" class="w-full text-left p-3 text-red-500 hover:bg-red-50 rounded-xl font-bold transition flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Logout Partner</button>
                </div>
            </nav>
        </aside>

        <div class="flex-grow flex flex-col h-screen overflow-hidden">
            <div class="md:hidden bg-white shadow-md p-4 flex justify-between items-center z-10 sticky top-0 h-16">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="text-gray-600 p-2 rounded-lg bg-gray-100 active:bg-gray-200"><i class="fas fa-bars text-xl"></i></button>
                    <span class="font-bold text-teal-600 text-lg">Partner Dashboard</span>
                </div>
                <div class="w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 font-bold text-xs"><i class="fas fa-store"></i></div>
            </div>

            <main class="flex-grow overflow-y-auto p-4 md:p-8">
                <div id="admin-view-products" class="fade-in pb-20">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">Your Inventory</h2>
                        <button onclick="openProductModal()" class="bg-gray-900 text-white px-5 py-3 rounded-xl font-bold hover:bg-black shadow-lg flex items-center gap-2 w-full md:w-auto justify-center transition active:scale-95"><i class="fas fa-plus"></i> Add Product</button>
                    </div>
                    <input type="text" id="adminProdSearch" onkeyup="filterAdminProducts()" placeholder="Search products..." class="w-full p-3 border border-gray-200 rounded-xl bg-white shadow-sm mb-4">
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[600px]">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider"><tr><th class="p-4">Product</th><th class="p-4">Price</th><th class="p-4">Stock</th><th class="p-4 text-center">Actions</th></tr></thead>
                                <tbody id="adminProductTable" class="divide-y divide-gray-100 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-view-orders" class="hidden-section fade-in pb-20">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Orders</h2>
                        <button onclick="fetchAdminOrders()" class="text-teal-600 bg-white p-2 rounded-lg shadow-sm hover:shadow-md transition"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <div class="flex gap-2 mb-6 overflow-x-auto pb-1 no-scrollbar">
                        <button onclick="filterAdminOrders('Active')" id="ordTab-Active" class="px-5 py-2 rounded-full font-bold text-sm border transition whitespace-nowrap bg-teal-600 text-white border-teal-600 shadow-md">Pending</button>
                        <button onclick="filterAdminOrders('Completed')" id="ordTab-Completed" class="px-5 py-2 rounded-full font-bold text-sm border bg-white text-gray-500 border-gray-200 transition whitespace-nowrap">Completed</button>
                        <button onclick="filterAdminOrders('Cancelled')" id="ordTab-Cancelled" class="px-5 py-2 rounded-full font-bold text-sm border bg-white text-gray-500 border-gray-200 transition whitespace-nowrap">Cancelled</button>
                    </div>
                    <div id="adminOrderList" class="grid grid-cols-1 xl:grid-cols-2 gap-4"></div>
                </div>
            </main>
        </div>
    </div>

    <div id="prodDetailModal" class="fixed inset-0 hidden z-[120] flex items-end md:items-center justify-center modal-overlay">
        <div class="bg-white w-full md:max-w-xl h-[95vh] md:h-auto md:max-h-[90vh] rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden flex flex-col fade-in">
             <div class="relative h-[40vh] bg-white flex-shrink-0 border-b border-gray-100 p-2">
                 <img id="pd_img" src="" class="w-full h-full object-contain">
                 <button onclick="closeModal('prodDetailModal')" class="absolute top-4 right-4 bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center text-gray-800 hover:bg-gray-200 transition shadow-sm"><i class="fas fa-times text-lg"></i></button>
             </div>
             <div class="p-6 overflow-y-auto flex-grow bg-white">
                 <div class="flex justify-between items-start mb-2">
                     <h2 id="pd_name" class="text-2xl font-bold text-gray-800 leading-tight">Product Name</h2>
                     <div class="text-xl font-extrabold text-teal-600" id="pd_price">â‚¹0</div>
                 </div>
                 <div class="flex items-center gap-2 mb-4 text-xs text-gray-500">
                     <span id="pd_cat" class="bg-teal-50 text-teal-700 px-2 py-1 rounded border border-teal-100 uppercase tracking-wide">Category</span>
                     <span class="mx-1">â€¢</span>
                     <i class="fas fa-store text-teal-500"></i> <span id="pd_store">Store</span>
                 </div>
                 
                 <div class="bg-teal-50 p-4 rounded-xl border border-teal-100 mb-4">
                     <h4 class="font-bold text-xs text-teal-700 uppercase mb-1"><i class="fas fa-map-pin mr-1"></i> Store Location</h4>
                     <p id="pd_addr" class="text-sm text-gray-800 font-medium">Loading address...</p>
                     <p id="pd_city" class="text-xs text-gray-500 mt-1">City</p>
                 </div>

                 <div class="mb-6">
                     <h4 class="font-bold text-sm text-gray-900 mb-2">Description</h4>
                     <p id="pd_desc" class="text-gray-600 text-sm leading-relaxed">No description available.</p>
                 </div>
             </div>
             <div class="p-4 border-t border-gray-100 bg-white md:rounded-b-3xl pb-safe">
                 <button id="pd_btn" class="w-full bg-teal-600 text-white py-4 rounded-xl font-bold hover:bg-teal-700 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">
                     <span>Add to Cart</span>
                 </button>
             </div>
        </div>
    </div>

    <div id="prodModal" class="fixed inset-0 hidden z-[160] flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="font-bold text-xl text-gray-800" id="prodModalTitle">Add Product</h3>
                <button onclick="closeModal('prodModal')" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <form id="prodForm" onsubmit="handleProdSave(event)" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" name="product_id" id="f_pid"><input type="hidden" name="store_id" id="f_sid">
                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Product Name</label><input name="medicine_name" id="f_name" required class="w-full border p-3 rounded-xl mt-1 focus:ring-2 focus:ring-teal-500 outline-none"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Category</label><input name="category" id="f_cat" list="cats" class="w-full border p-3 rounded-xl mt-1 outline-none"><datalist id="cats">
                        <option value="Tablet"><option value="Capsule"><option value="Syrup"><option value="Injection"><option value="Drops"><option value="Cream"><option value="Inhaler"><option value="Surgical"><option value="Ayurvedic"><option value="Baby Care"><option value="Personal Care"><option value="Supplements">
                    </datalist></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Price (â‚¹)</label><input type="number" name="price" id="f_price" required class="w-full border p-3 rounded-xl mt-1 outline-none"></div>
                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Image URL</label><input type="url" name="image_url" id="f_img" class="w-full border p-3 rounded-xl mt-1 outline-none" placeholder="https://..."></div>
                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Description</label><textarea name="description" id="f_desc" rows="3" class="w-full border p-3 rounded-xl mt-1 outline-none"></textarea></div>
                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Private Notes</label><textarea name="private_notes" id="f_note" rows="1" class="w-full border p-3 bg-yellow-50 rounded-xl mt-1 outline-none"></textarea></div>
                <div class="md:col-span-2"><label class="flex items-center gap-2 font-bold text-gray-700 cursor-pointer p-2 border rounded-xl"><input type="checkbox" name="in_stock" id="f_stock" value="TRUE" checked class="w-5 h-5 accent-teal-600"> <span>Product is In Stock</span></label></div>
                <div class="md:col-span-2 mt-2"><button type="submit" id="btnSaveProd" class="w-full bg-black text-white p-4 rounded-xl font-bold hover:bg-gray-800 shadow-lg text-lg">Save Product</button></div>
            </form>
        </div>
    </div>

    <div id="cartModal" class="fixed inset-0 hidden z-[130] flex items-end sm:items-center justify-center modal-overlay sm:p-4">
        <div class="bg-white w-full sm:max-w-lg h-[85vh] sm:h-auto sm:max-h-[85vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl fade-in transform transition-transform">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-xl text-gray-800">Your Cart</h3>
                <button onclick="closeModal('cartModal')" class="text-gray-400 hover:text-red-500 text-2xl transition">&times;</button>
            </div>
            <div id="cartContent" class="p-5 overflow-y-auto flex-grow bg-white space-y-4"></div>
            <div class="p-5 border-t border-gray-100 bg-gray-50 rounded-b-3xl shrink-0 pb-safe">
                <div class="flex justify-between font-bold text-xl mb-4 text-gray-800"><span>To Pay</span><span id="cartTotal" class="text-teal-600">â‚¹0</span></div>
                <button onclick="checkout()" id="btnCheckout" class="w-full bg-teal-600 text-white py-4 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg text-lg">Place Order</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 hidden z-[90] flex items-center justify-center modal-overlay p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center fade-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 text-4xl shadow-inner"><i class="fas fa-check"></i></div>
            <h3 class="text-2xl font-extrabold text-gray-800 mb-2">Order Placed!</h3>
            <div id="successDetails" class="bg-gray-50 rounded-xl p-5 text-left space-y-4 mb-6 max-h-60 overflow-y-auto border border-gray-200 shadow-inner"></div>
            <button onclick="closeModal('successModal')" class="mt-6 w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg">Okay</button>
        </div>
    </div>
    
    <div id="partnerSuccessModal" class="fixed inset-0 hidden z-[90] flex items-center justify-center modal-overlay p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center fade-in border-t-8 border-teal-500">
            <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-store text-teal-600 text-4xl"></i></div>
            <h3 class="text-2xl font-extrabold text-gray-800 mb-2">Registration Successful!</h3>
            <div class="bg-gray-100 p-4 rounded-xl mb-6 border border-gray-200"><p class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Your Store ID</p><p id="regSuccessId" class="text-3xl font-mono font-bold text-teal-700 tracking-widest select-all">MED-XXXX</p></div>
            <button onclick="finishPartnerReg()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 shadow-lg">Go to Login</button>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 hidden z-[170] flex items-center justify-center modal-overlay p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md relative fade-in">
            <button onclick="closeModal('authModal')" class="absolute top-5 right-5 text-gray-300 hover:text-gray-600 text-xl transition">&times;</button>
            <div id="authContent"></div>
        </div>
    </div>
    
    <div id="mobileMenuModal" class="fixed inset-0 hidden z-[200] flex items-end justify-center modal-overlay md:hidden">
        <div class="bg-white w-full rounded-t-3xl shadow-2xl p-6 fade-in flex flex-col gap-2 pb-safe">
            <div class="flex justify-center mb-2"><div class="w-12 h-1.5 bg-gray-200 rounded-full"></div></div>
            
            <div id="mobMenuHeader" class="mb-4 text-center"></div>

            <button onclick="closeModal('mobileMenuModal');showPublicHome()" class="w-full text-left p-4 rounded-xl bg-gray-50 hover:bg-gray-100 font-bold text-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-teal-600 shadow-sm"><i class="fas fa-home"></i></div> Home
            </button>
            
            <button onclick="closeModal('mobileMenuModal');showSection('myorders');loadCustomerOrders()" class="w-full text-left p-4 rounded-xl bg-gray-50 hover:bg-gray-100 font-bold text-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm"><i class="fas fa-receipt"></i></div> My Orders
            </button>

            <button onclick="closeModal('mobileMenuModal');showSection('about')" class="w-full text-left p-4 rounded-xl bg-gray-50 hover:bg-gray-100 font-bold text-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-purple-500 shadow-sm"><i class="fas fa-info"></i></div> About Us
            </button>

            <button onclick="closeModal('mobileMenuModal');showSection('contact')" class="w-full text-left p-4 rounded-xl bg-gray-50 hover:bg-gray-100 font-bold text-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-orange-500 shadow-sm"><i class="fas fa-headset"></i></div> Contact Support
            </button>

            <div id="mobMenuAuth" class="mt-2 grid grid-cols-2 gap-3">
                </div>
            
            <button onclick="closeModal('mobileMenuModal')" class="mt-4 w-full py-3 text-gray-400 font-bold">Close</button>
        </div>
    </div>

    <script>
    // *** CONFIG ***
    const API = 'https://script.google.com/macros/s/AKfycbyvl7ezlg-g-u0XUCTkIEFjBs8Nm6gFA5vNy7EVINSF0WRlkPqTHnKUefnSSPsGLyc1lA/exec';
    const KEY_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQY2BokImG-lKK2HjjAPxJIi2kwTLVuELWKB8BQXDEFRjG5cXn4Tj0x_qivopk9DPCCBBGDUF06FBvU/pub?output=csv';
    
    let GEMINI_API_KEY = null;
    let rawProducts=[], cart=[], user=null;
    let partnerId=null, partnerName='Partner';
    let rawAdminProducts=[], rawAdminOrders=[], rawCustomerOrders=[];
    let activeAdminOrderTab = 'Active';

    // *** INIT ***
    window.onload = async () => {
        if(localStorage.getItem('mediUser')) user=JSON.parse(localStorage.getItem('mediUser'));
        if(localStorage.getItem('mediPartner')) { const pData = JSON.parse(localStorage.getItem('mediPartner')); partnerId = pData.id; partnerName = pData.name; }
        updateAuthUI();
        loadHome();
        try { await fetchApiKey(); } catch(e) { console.warn("AI Key not loaded", e); }
    };

    // *** UPDATED AUTH & UI LOGIC ***
    function updateAuthUI() {
        const d = document.getElementById('authContainer');
        const m = document.getElementById('mobNavProfile'); // Bottom Bar Icon

        // 1. Desktop UI
        if(user) {
            d.innerHTML = `<span class="text-sm font-bold text-gray-700 hidden md:inline">Hi, ${user.name.split(' ')[0]}</span><button onclick="logoutUser()" class="text-sm text-red-500 font-bold hover:text-red-700">Logout</button>`;
        } else {
            d.innerHTML = `<button onclick="openAuth('login')" class="font-bold text-sm text-teal-600 hover:text-teal-800 transition mr-2">Login</button><button onclick="checkPartnerAndRedirect()" class="bg-gray-900 text-white text-xs px-4 py-2 rounded-full shadow-lg hover:bg-gray-800 transition">Partner</button>`;
        }
        if(partnerId) d.innerHTML += `<button onclick="loadAdminData()" class="ml-2 bg-teal-600 text-white text-xs px-3 py-1 rounded-full font-bold shadow animate-pulse">Dashboard</button>`;

        // 2. Mobile Bottom Bar Icon (Connects to New Menu)
        if(user) {
            m.innerHTML = `<i class="fas fa-user-circle text-2xl text-teal-600"></i><span class="text-[10px] font-bold text-teal-600">Profile</span>`;
        } else {
            m.innerHTML = `<i class="fas fa-user-circle text-2xl text-gray-400"></i><span class="text-[10px] font-bold text-gray-500">Menu</span>`;
        }
        // Instead of logging in directly, open the MENU
        m.onclick = () => openMobileMenu();
    }

    // *** NEW MOBILE MENU LOGIC ***
    function openMobileMenu() {
        const header = document.getElementById('mobMenuHeader');
        const authBox = document.getElementById('mobMenuAuth');
        
        if(user) {
            header.innerHTML = `<h3 class="text-xl font-bold text-gray-800">Hi, ${user.name}</h3><p class="text-xs text-gray-400">Welcome back to Nacsum</p>`;
            authBox.innerHTML = `
                <button onclick="checkPartnerAndRedirect();closeModal('mobileMenuModal')" class="bg-gray-100 text-gray-800 py-3 rounded-xl font-bold">Partner Area</button>
                <button onclick="logoutUser();closeModal('mobileMenuModal')" class="bg-red-50 text-red-600 py-3 rounded-xl font-bold">Logout</button>
            `;
        } else {
            header.innerHTML = `<h3 class="text-xl font-bold text-gray-800">Welcome Guest</h3><p class="text-xs text-gray-400">Login to manage orders</p>`;
            authBox.innerHTML = `
                <button onclick="openAuth('partner');closeModal('mobileMenuModal')" class="bg-gray-100 text-gray-800 py-3 rounded-xl font-bold">Partner Login</button>
                <button onclick="openAuth('login');closeModal('mobileMenuModal')" class="bg-teal-600 text-white py-3 rounded-xl font-bold shadow-lg">Login / Sign Up</button>
            `;
        }
        document.getElementById('mobileMenuModal').classList.remove('hidden');
    }

    function checkPartnerAndRedirect() { if(partnerId) loadAdminData(); else openAuth('partner'); }
    function switchToHome() { document.getElementById('app-admin').classList.add('hidden-section'); document.getElementById('app-public').classList.remove('hidden-section'); window.scrollTo(0,0); }

    // *** HOME & SEARCH ***
    async function loadHome() {
        document.getElementById('mainLoader').classList.remove('hidden');
        try {
            const res = await fetch(`${API}?action=get_all_data`);
            const d = await res.json();
            rawProducts = d.products || [];
            renderPublicGrid(rawProducts);
            populateCityDropdown(rawProducts);
        } catch(e) { toast('Error loading data', 'error'); }
        document.getElementById('mainLoader').classList.add('hidden');
    }

    function populateCityDropdown(products) {
        const cities = new Set(); products.forEach(p => { if(p.store_city) cities.add(p.store_city); });
        const sel = document.getElementById('cityFilter'); sel.innerHTML = '<option value="All">All Cities</option>';
        cities.forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    function filterCat(cat) { if(cat === 'All') renderPublicGrid(rawProducts); else renderPublicGrid(rawProducts.filter(p => p.category === cat)); }
    
    function searchPublic() { 
        const q = document.getElementById('publicSearch').value.toLowerCase(); 
        const cityFilter = document.getElementById('cityFilter').value;
        const filtered = rawProducts.filter(p => {
            if(cityFilter !== 'All' && p.store_city !== cityFilter) return false;
            if(q === '') return true;
            return (p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q) || p.store_name.toLowerCase().includes(q) || (p.store_city && p.store_city.toLowerCase().includes(q)));
        });
        renderPublicGrid(filtered); 
    }

    // *** GRID & CART BUTTONS ***
    function getQty(id) { const item = cart.find(x => x.id === id); return item ? item.qty : 0; }
    
    function renderPublicGrid(list) {
        const div = document.getElementById('publicGrid'); div.innerHTML = '';
        if(!list.length) return div.innerHTML='<p class="col-span-full text-center text-gray-400 py-10 italic">No medicines found.</p>';
        
        list.forEach(p => {
            const stock = p.in_stock==='TRUE'||p.in_stock===true;
            const img = p.image || 'https://via.placeholder.com/300?text=No+Image';
            const qty = getQty(p.id);
            
            let btnHtml = '';
            if(!stock) {
                btnHtml = `<button disabled class="bg-gray-100 text-gray-400 w-full h-8 rounded-lg text-xs font-bold cursor-not-allowed">N/A</button>`;
            } else if (qty > 0) {
                btnHtml = `
                    <div class="flex items-center justify-between bg-teal-600 text-white rounded-lg w-24 h-8 px-2 shadow-md">
                        <button onclick="event.stopPropagation();updateQty('${p.id}', -1)" class="w-6 h-full flex items-center justify-center hover:bg-teal-700 rounded"><i class="fas fa-minus text-[10px]"></i></button>
                        <span class="font-bold text-sm">${qty}</span>
                        <button onclick="event.stopPropagation();updateQty('${p.id}', 1)" class="w-6 h-full flex items-center justify-center hover:bg-teal-700 rounded"><i class="fas fa-plus text-[10px]"></i></button>
                    </div>`;
            } else {
                btnHtml = `<button onclick="event.stopPropagation();updateQty('${p.id}', 1)" class="bg-teal-50 text-teal-700 border border-teal-100 hover:bg-teal-600 hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition shadow-sm"><i class="fas fa-plus"></i></button>`;
            }
            
            div.innerHTML += `
                <div class="bg-white rounded-2xl shadow-[0_2px_8px_rgba(0,0,0,0.04)] hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden flex flex-col group relative cursor-pointer" onclick='openProductDetailModal(${JSON.stringify(p)})'>
                    ${!stock ? '<span class="absolute top-2 left-2 bg-gray-900 text-white text-[10px] font-bold px-2 py-1 rounded-md z-10 opacity-90">Out of Stock</span>' : ''}
                    <div class="h-36 overflow-hidden bg-white relative p-3 flex items-center justify-center">
                        <img src="${img}" class="w-full h-full object-contain group-hover:scale-105 transition duration-700" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=Image+Error'">
                    </div>
                    <div class="p-3 flex-grow flex flex-col">
                        <div class="flex items-center gap-1 mb-1 text-[10px] text-gray-500 font-bold uppercase tracking-wider bg-gray-50 w-fit px-1.5 py-0.5 rounded"><i class="fas fa-store text-teal-500"></i> ${p.store_name}</div>
                        <h3 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2 mb-1">${p.name}</h3>
                        <p class="text-[10px] text-gray-400 mb-2 truncate">${p.category}</p>
                        <div class="mt-auto flex justify-between items-end">
                            <div><div class="text-[10px] text-gray-400 flex items-center gap-1"><i class="fas fa-map-marker-alt"></i> ${p.store_city || 'Nearby'}</div><span class="font-extrabold text-lg text-gray-900">â‚¹${p.price}</span></div>
                            <div id="btn-container-${p.id}">${btnHtml}</div>
                        </div>
                    </div>
                </div>`;
        });
    }

    // *** CART ***
    function updateQty(id, change) {
        const p = rawProducts.find(x => x.id === id);
        let item = cart.find(x => x.id === id);
        
        if (!item) {
            if (change > 0) { cart.push({ ...p, qty: 1 }); toast('Added to Cart'); }
        } else {
            item.qty += change;
            if (item.qty <= 0) { cart = cart.filter(x => x.id !== id); }
        }
        updateCartUI();
        
        // Re-render button locally
        const container = document.getElementById(`btn-container-${id}`);
        if(container) {
            const newQty = getQty(id);
            if (newQty > 0) {
                container.innerHTML = `<div class="flex items-center justify-between bg-teal-600 text-white rounded-lg w-24 h-8 px-2 shadow-md"><button onclick="event.stopPropagation();updateQty('${id}', -1)" class="w-6 h-full flex items-center justify-center hover:bg-teal-700 rounded"><i class="fas fa-minus text-[10px]"></i></button><span class="font-bold text-sm">${newQty}</span><button onclick="event.stopPropagation();updateQty('${id}', 1)" class="w-6 h-full flex items-center justify-center hover:bg-teal-700 rounded"><i class="fas fa-plus text-[10px]"></i></button></div>`;
            } else {
                container.innerHTML = `<button onclick="event.stopPropagation();updateQty('${id}', 1)" class="bg-teal-50 text-teal-700 border border-teal-100 hover:bg-teal-600 hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition shadow-sm"><i class="fas fa-plus"></i></button>`;
            }
        }
    }
    
    function updateCartUI() { 
        const count = cart.reduce((a,b)=>a+b.qty,0); 
        const mBadge = document.getElementById('cartCountMob'); 
        if(count>0) { mBadge.innerText=count; mBadge.classList.remove('hidden'); } else mBadge.classList.add('hidden'); 
    }

    function openCart() { 
        document.getElementById('cartModal').classList.remove('hidden'); const div = document.getElementById('cartContent'); div.innerHTML=''; let t=0; 
        if(!cart.length) div.innerHTML='<div class="text-center py-10"><i class="fas fa-shopping-basket text-4xl text-gray-200 mb-3"></i><p class="text-gray-400">Your cart is empty.</p></div>'; 
        cart.forEach((i) => { 
            t += Number(i.price) * i.qty;
            div.innerHTML += `<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-gray-100 shadow-sm mb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-teal-50 rounded-lg flex items-center justify-center text-teal-600"><i class="fas fa-pills"></i></div><div><b class="text-gray-800 text-sm block">${i.name}</b><span class="text-xs text-gray-500">${i.store_name}</span></div></div><div class="flex items-center gap-3"><button class="w-6 h-6 bg-gray-100 rounded text-xs font-bold" onclick="updateQty('${i.id}', -1);openCart()">-</button><span class="font-bold text-gray-800 text-sm">${i.qty}</span><button class="w-6 h-6 bg-gray-100 rounded text-xs font-bold" onclick="updateQty('${i.id}', 1);openCart()">+</button><span class="font-bold text-gray-800 w-12 text-right">â‚¹${i.price*i.qty}</span></div></div>`; 
        }); 
        document.getElementById('cartTotal').innerText = 'â‚¹'+t; 
    }

    async function checkout() { 
        if(!user) { closeModal('cartModal'); return openAuth('login'); } if(!cart.length) return; 
        setLoading('btnCheckout', true); const orders = {}; 
        cart.forEach(i => { if(!orders[i.store_id]) orders[i.store_id]=[]; orders[i.store_id].push(i); }); 
        const successData = []; 
        for(const sid in orders) { 
            const items = orders[sid]; const total = items.reduce((s,i)=>s+(Number(i.price)*i.qty),0); 
            const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'place_order', store_id:sid, customer_name:user.name, customer_phone:user.phone, customer_address:user.address, order_items: JSON.stringify(items.map(x=>({name:x.name, price:x.price, qty:x.qty}))), total_amount: total})}); 
            const d = await res.json(); if(d.status==='success') successData.push({store:d.store_name, phone:d.store_phone, items:items.length}); 
        } 
        setLoading('btnCheckout', false); cart=[]; updateCartUI(); closeModal('cartModal'); loadHome();
        const detDiv = document.getElementById('successDetails'); detDiv.innerHTML=''; successData.forEach(s => { detDiv.innerHTML += `<div class="border-b border-gray-100 last:border-0 pb-3 mb-3"><p class="font-bold text-gray-800 text-lg">${s.store}</p><p class="text-xs text-gray-500 mb-2">Orders Sent</p><a href="tel:${s.phone}" class="inline-flex items-center gap-2 text-teal-600 text-xs font-bold bg-teal-50 px-3 py-1 rounded-full"><i class="fas fa-phone-alt"></i> ${s.phone}</a></div>`; }); 
        document.getElementById('successModal').classList.remove('hidden'); 
    }

    // *** PRODUCT DETAIL ***
    function openProductDetailModal(p) {
        if(!p) return; const stock = p.in_stock==='TRUE'||p.in_stock===true;
        document.getElementById('pd_img').src = p.image || 'https://via.placeholder.com/500?text=No+Image';
        document.getElementById('pd_name').innerText = p.name;
        document.getElementById('pd_price').innerText = 'â‚¹' + p.price;
        document.getElementById('pd_cat').innerText = p.category;
        document.getElementById('pd_store').innerText = p.store_name;
        document.getElementById('pd_city').innerText = p.store_city || 'City not listed';
        document.getElementById('pd_desc').innerText = p.description || 'No description.';
        document.getElementById('pd_addr').innerText = p.store_address || 'Address hidden.'; 
        const btn = document.getElementById('pd_btn');
        if(stock) { btn.innerHTML = `<span>Add to Cart</span>`; btn.className = "w-full bg-teal-600 text-white py-4 rounded-xl font-bold hover:bg-teal-700 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg"; btn.onclick = () => { updateQty(p.id, 1); closeModal('prodDetailModal'); }; btn.disabled = false; } 
        else { btn.innerHTML = `<span>Out of Stock</span>`; btn.className = "w-full bg-gray-300 text-gray-500 py-4 rounded-xl font-bold cursor-not-allowed flex justify-center items-center gap-2 text-lg"; btn.disabled = true; }
        document.getElementById('prodDetailModal').classList.remove('hidden');
    }

    // *** AI CONSULTANT ***
    function fetchApiKey() { return new Promise((resolve, reject) => { Papa.parse(KEY_CSV, { download: true, header: false, complete: function(results) { if (results.data) { for (let row of results.data) { if (row[0] && row[0].trim() === 'Gemini' && row[1]) { GEMINI_API_KEY = row[1].trim(); resolve(GEMINI_API_KEY); return; } } } reject(new Error("Key not found")); }, error: function(err) { reject(err); } }); }); }
    
    async function fetchWithBackoff(payload) {
            const models = ['gemini-3-flash-preview', 'gemini-1.5-flash', 'gemini-pro']; 
            let lastError = null;
            for (const model of models) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) return await response.json();
                    if (response.status === 404) { console.warn(`Model ${model} not found (404). Trying next...`); continue; }
                    throw new Error(`API Error ${response.status}`);
                } catch (error) { lastError = error; }
            }
            throw lastError || new Error("All AI models failed.");
    }

    // *** AI CHAT LOGIC ***

    function toggleAiChat() { 
        const w = document.getElementById('aiChatWindow'); 
        if(w.classList.contains('hidden')) { 
            w.classList.remove('hidden'); 
            setTimeout(()=>document.getElementById('aiInput').focus(), 100); 
        } else { 
            w.classList.add('hidden'); 
        } 
    }

    function handleAiEnter(e) { if(e.key === 'Enter') sendAiMessage(); }

    async function sendAiMessage() {
        if(!GEMINI_API_KEY) await fetchApiKey();
        
        const input = document.getElementById('aiInput'); 
        const msg = input.value.trim(); 
        if(!msg) return;

        // 1. User Message
        addChatBubble(msg, 'user'); 
        input.value = '';
        
        // 2. Show Typing Indicator
        document.getElementById('aiTyping').classList.remove('hidden'); 
        const msgsDiv = document.getElementById('aiMessages'); 
        msgsDiv.scrollTop = msgsDiv.scrollHeight;

        // 3. Prepare Context
        const stockContext = rawProducts && rawProducts.length > 0 
            ? rawProducts.map(p => `${p.name} (Store: ${p.store_name}, Price: â‚¹${p.price})`).join(', ') 
            : "No specific stock data available right now.";

        const prompt = `
            System: You are an expert Medical Consultant for "Nacsum Biotech". 
            Context: We connect patients to local pharmacies. 
            Current Stock: [${stockContext}]. 
            
            User Question: "${msg}"
            
            Instructions: 
            1. If the user asks for a medicine in our stock, tell them the price and store name.
            2. If they ask about symptoms, give brief, professional medical advice.
            3. Keep the answer short (under 50 words).
        `;

        try {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const data = await fetchWithBackoff(payload);
            
            document.getElementById('aiTyping').classList.add('hidden');

            if (data?.candidates?.[0]?.content) {
                const aiResponse = data.candidates[0].content.parts[0].text;
                addChatBubble(aiResponse, 'ai');
            } else {
                addChatBubble("I'm sorry, I couldn't process that. Please try again.", 'ai');
            }

        } catch (error) { 
            document.getElementById('aiTyping').classList.add('hidden'); 
            addChatBubble("Connection error. Please check your internet.", 'ai'); 
        }
    }

    function addChatBubble(text, sender) { 
        const div = document.getElementById('aiMessages'); 
        const isAi = sender === 'ai'; 
        
        // ** ADDED DISCLAIMER LOGIC HERE **
        let content = marked.parse(text);
        
        if (isAi) {
            content += `
                <div class="mt-3 pt-3 border-t border-gray-100 text-[10px] text-gray-400 leading-tight">
                    <i class="fas fa-exclamation-circle text-teal-500 mr-1"></i> 
                    <b>Note:</b> Consult a Doctor for serious conditions.<br>
                    <span class="block mt-1">
                        <i class="fas fa-phone-alt mr-1"></i> <a href="tel:+918850102255" class="hover:text-teal-600">+918850102255</a>, <a href="tel:+918268400523" class="hover:text-teal-600">+918268400523</a>
                    </span>
                </div>
            `;
        }

        const html = `
            <div class="flex gap-3 ${isAi?'':'flex-row-reverse'} fade-in">
                <div class="w-8 h-8 rounded-full ${isAi?'bg-teal-100 text-teal-600':'bg-gray-800 text-white'} flex-shrink-0 flex items-center justify-center text-xs shadow-sm">
                    <i class="fas ${isAi?'fa-user-md':'fa-user'}"></i>
                </div>
                <div class="${isAi?'bg-white text-gray-700 rounded-tl-none border border-gray-100':'bg-teal-600 text-white rounded-tr-none shadow-lg'} p-3.5 rounded-2xl shadow-sm text-sm max-w-[85%]">
                    <div class="prose prose-sm ${isAi ? '' : 'text-white'}">
                        ${content}
                    </div>
                </div>
            </div>`;
            
        div.insertAdjacentHTML('beforeend', html); 
        div.scrollTop = div.scrollHeight; 
    }

    // *** ADMIN & UTILS ***
    async function loadAdminData() { document.getElementById('app-public').classList.add('hidden-section'); document.getElementById('app-admin').classList.remove('hidden-section'); document.getElementById('adminProfileInfo').innerHTML = `<h2 class="font-bold text-xl text-gray-800 leading-tight">${partnerName}</h2><p class="text-xs text-gray-500 font-mono mt-1 bg-white border border-gray-200 p-1 px-2 rounded-lg inline-block tracking-wider">ID: ${partnerId}</p>`; document.getElementById('f_sid').value = partnerId; fetchAdminProducts(); }
    async function fetchAdminProducts(){ document.getElementById('adminProductTable').innerHTML='<tr><td colspan="4" class="p-10 text-center"><div class="spinner spinner-dark"></div> Loading Inventory...</td></tr>'; const res=await fetch(`${API}?action=get_store_products&store_id=${partnerId}`); const d=await res.json(); rawAdminProducts=d.products||[]; renderAdminProducts(); }
    function renderAdminProducts(){ const q=document.getElementById('adminProdSearch').value.toLowerCase(); const t=document.getElementById('adminProductTable'); t.innerHTML=''; rawAdminProducts.filter(p=>p.name.toLowerCase().includes(q)).forEach(p=>{ const stk = p.in_stock==='TRUE'||p.in_stock===true; const img = p.image || 'https://via.placeholder.com/100?text=No+Img'; t.innerHTML+=`<tr class="border-b last:border-0 hover:bg-gray-50 transition group"><td class="p-4 flex items-center gap-3"><img src="${img}" class="w-12 h-12 rounded-lg object-cover border border-gray-200" onerror="this.src='https://via.placeholder.com/100?text=Error'"><div><div class="font-bold text-gray-800 text-sm">${p.name}</div><div class="text-[10px] text-gray-500 uppercase">${p.category}</div></div></td><td class="p-4 font-bold text-gray-700">â‚¹${p.price}</td><td class="p-4"><button onclick="toggleStock('${p.id}',${!stk})" class="${stk?'bg-green-100 text-green-700 border border-green-200':'bg-red-100 text-red-700 border border-red-200'} text-[10px] font-bold px-3 py-1.5 rounded-full w-24 text-center transition hover:scale-105 shadow-sm">${stk?'IN STOCK':'STOCK OUT'}</button></td><td class="p-4 text-center"><button onclick='openProductModal(${JSON.stringify(p)})' class="text-gray-400 hover:text-teal-600 p-2 transition"><i class="fas fa-edit"></i></button><button onclick="delProd('${p.id}')" class="text-gray-400 hover:text-red-500 p-2 transition"><i class="fas fa-trash-alt"></i></button></td></tr>`; }); }
    // --- ADMIN ORDER LOGIC ---

    async function fetchAdminOrders() {
        const listDiv = document.getElementById('adminOrderList');
        
        // 1. Show Loading Spinner
        listDiv.innerHTML = '<div class="col-span-1 xl:col-span-2 text-center py-20"><div class="spinner spinner-dark"></div><p class="mt-3 text-gray-500 text-sm">Syncing Orders...</p></div>';

        // 2. Safety Check for Partner ID
        if (!partnerId) {
            listDiv.innerHTML = '<div class="col-span-1 xl:col-span-2 text-center py-10 text-red-500 font-bold bg-red-50 rounded-xl">Session Expired. Please Logout and Login again.</div>';
            return;
        }

        try {
            // 3. Fetch Data
            const res = await fetch(`${API}?action=get_store_orders&store_id=${partnerId}`);
            
            // 4. Validate Response
            const textData = await res.text();
            let d;
            try {
                d = JSON.parse(textData);
            } catch (e) {
                console.error("Invalid JSON:", textData);
                throw new Error("Server Error: Invalid Data received.");
            }

            if (d.status === 'error') {
                throw new Error(d.message || 'Database returned an error');
            }

            // 5. Update State & Render
            rawAdminOrders = d.orders || [];
            filterAdminOrders(activeAdminOrderTab);

        } catch (error) {
            console.error("Order Sync Error:", error);
            listDiv.innerHTML = `
                <div class="col-span-1 xl:col-span-2 text-center py-10 bg-red-50 rounded-2xl border border-red-100 p-6">
                    <i class="fas fa-exclamation-circle text-red-400 text-3xl mb-3"></i>
                    <p class="text-gray-800 font-bold">Failed to load orders</p>
                    <p class="text-xs text-red-500 mb-4">${error.message}</p>
                    <button onclick="fetchAdminOrders()" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-red-700 transition">Retry</button>
                </div>`;
        }
    }

    function filterAdminOrders(tab) {
        activeAdminOrderTab = tab;
        
        // Update Tab Styles
        ['Active', 'Completed', 'Cancelled'].forEach(t => {
            const btn = document.getElementById(`ordTab-${t}`);
            if(btn) { // Safety check in case button IDs change
                if (t === tab) {
                    btn.className = "px-5 py-2 rounded-full font-bold text-sm border transition whitespace-nowrap bg-teal-600 text-white border-teal-600 shadow-md";
                } else {
                    btn.className = "px-5 py-2 rounded-full font-bold text-sm border bg-white text-gray-500 border-gray-200 transition whitespace-nowrap hover:bg-gray-50";
                }
            }
        });

        renderAdminOrders();
    }

    function renderAdminOrders() {
        const div = document.getElementById('adminOrderList');
        if (!div) return;
        div.innerHTML = '';

        // 1. Search Query Safety Check
        const searchInput = document.getElementById('adminOrderSearch');
        const q = searchInput ? searchInput.value.toLowerCase() : '';

        // 2. Filter List based on Tab
        let list = [];
        if (activeAdminOrderTab === 'Active') {
            list = rawAdminOrders.filter(o => o.status === 'Pending' || o.status === 'Approved');
        } else if (activeAdminOrderTab === 'Completed') {
            list = rawAdminOrders.filter(o => o.status === 'Delivered');
        } else {
            list = rawAdminOrders.filter(o => o.status === 'Cancelled' || o.status === 'Refused');
        }

        // 3. Filter List based on Search
        if(q) {
            list = list.filter(o => 
                o.customer_name.toLowerCase().includes(q) || 
                o.order_id.toLowerCase().includes(q)
            );
        }

        // 4. Empty State
        if (!list.length) {
            div.innerHTML = '<div class="col-span-1 xl:col-span-2 text-center py-12 bg-white rounded-3xl border border-dashed border-gray-300"><i class="fas fa-box-open text-3xl text-gray-200 mb-3"></i><p class="text-gray-400 text-sm">No orders found.</p></div>';
            return;
        }

        // 5. Render Items
        list.forEach(o => {
            // --- FORMAT DATE TIME ---
            let dateStr = "Date N/A";
            if (o.date) {
                const dateObj = new Date(o.date);
                // Format: "18 Dec, 6:30 PM"
                dateStr = dateObj.toLocaleDateString('en-IN', { 
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
                });
            }

            // Parse Items
            let itemsHtml = '';
            try {
                const items = JSON.parse(o.items);
                itemsHtml = items.map(i => `
                    <div class="flex justify-between text-sm py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-2 rounded">
                        <span class="text-gray-700 font-medium">${i.name}</span>
                        <div class="text-right">
                            <span class="text-xs font-bold text-gray-500 mr-2">x${i.qty || 1}</span>
                            <span class="font-bold text-gray-800">â‚¹${i.price}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) { itemsHtml = '<div class="text-red-400 text-xs italic p-2">Error parsing items.</div>'; }

            // Actions
            let actions = '';
            if (o.status === 'Pending') {
                actions = `
                    <div class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-gray-100">
                        <button onclick="setStatus('${o.order_id}','Approved')" class="bg-teal-600 text-white py-2.5 rounded-xl text-sm font-bold hover:bg-teal-700 shadow-md transition active:scale-95">Accept</button>
                        <button onclick="setStatus('${o.order_id}','Cancelled')" class="bg-white border border-gray-200 text-red-500 py-2.5 rounded-xl text-sm font-bold hover:bg-red-50 transition">Reject</button>
                    </div>`;
            } else if (o.status === 'Approved') {
                actions = `
                    <div class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-gray-100">
                        <button onclick="setStatus('${o.order_id}','Delivered')" class="bg-green-600 text-white py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 shadow-md transition active:scale-95">Deliver</button>
                        <button onclick="setStatus('${o.order_id}','Cancelled')" class="bg-white border border-gray-200 text-red-500 py-2.5 rounded-xl text-sm font-bold hover:bg-red-50 transition">Cancel</button>
                    </div>`;
            }

            // Render Card
            div.innerHTML += `
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg transition duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="font-bold text-gray-800 text-lg">${o.customer_name}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] text-gray-500 font-mono bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">#${o.order_id}</span>
                                <span class="text-[10px] text-teal-600 font-bold bg-teal-50 px-2 py-0.5 rounded border border-teal-100 flex items-center gap-1">
                                    <i class="far fa-clock"></i> ${dateStr}
                                </span>
                            </div>
                        </div>
                        <a href="tel:${o.customer_phone}" class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100 transition shadow-sm border border-green-100">
                            <i class="fas fa-phone-alt text-sm"></i>
                        </a>
                    </div>
                    
                    <div class="bg-blue-50/50 p-3 rounded-xl text-xs text-gray-600 mb-4 flex items-start gap-2 border border-blue-50">
                        <i class="fas fa-map-marker-alt text-blue-500 mt-0.5"></i> 
                        <span class="font-medium">${o.customer_address}</span>
                    </div>
                    
                    <div class="mb-4 bg-white border border-gray-100 rounded-xl p-1">
                        ${itemsHtml}
                    </div>
                    
                    <div class="flex justify-between items-center px-1">
                        <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">Total Amount</span>
                        <span class="text-xl font-extrabold text-gray-800">â‚¹${o.total}</span>
                    </div>
                    ${actions}
                </div>`;
        });
    }
    
    // Boilerplate Utils
    function toggleSidebar() { const s = document.getElementById('adminSidebar'); const o = document.getElementById('sidebarOverlay'); if(s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } }
    function finishPartnerReg() { closeModal('partnerSuccessModal'); openAuth('partner'); }
    function switchAdminView(v) { document.getElementById('admin-view-products').classList.add('hidden-section'); document.getElementById('admin-view-orders').classList.add('hidden-section'); document.getElementById(`admin-view-${v}`).classList.remove('hidden-section'); if(v==='orders') fetchAdminOrders(); }
    async function handleProdSave(e) { e.preventDefault(); setLoading('btnSaveProd',true); const d=Object.fromEntries(new FormData(e.target)); d.action=d.product_id?'edit_product':'add_product'; d.in_stock=document.getElementById('f_stock').checked?'TRUE':'FALSE'; await fetch(API,{method:'POST',body:JSON.stringify(d)}); setLoading('btnSaveProd',false); closeModal('prodModal'); fetchAdminProducts(); toast('Product Saved'); }
    function openProductModal(p=null) { document.getElementById('prodModal').classList.remove('hidden'); document.getElementById('prodForm').reset(); document.getElementById('prodModalTitle').innerText = p?'Edit Product':'Add Product'; document.getElementById('f_pid').value = p?p.id:''; document.getElementById('f_sid').value = partnerId; if(p){ document.getElementById('f_name').value=p.name; document.getElementById('f_cat').value=p.category; document.getElementById('f_price').value=p.price; document.getElementById('f_img').value=p.image; document.getElementById('f_desc').value=p.description; document.getElementById('f_note').value=p.private_notes; document.getElementById('f_stock').checked=(p.in_stock==='TRUE'||p.in_stock===true); } }
    async function toggleStock(pid, s) { rawAdminProducts.find(p=>p.id===pid).in_stock=s; renderAdminProducts(); await fetch(API,{method:'POST',body:JSON.stringify({action:'edit_product',product_id:pid,store_id:partnerId,only_stock:true,in_stock:s})}); toast('Stock updated'); }
    async function delProd(pid) { if(!confirm('Delete?'))return; await fetch(API,{method:'POST',body:JSON.stringify({action:'delete_product',product_id:pid,store_id:partnerId})}); fetchAdminProducts(); toast('Deleted'); }
    async function setStatus(oid, status) { const order = rawAdminOrders.find(o => o.order_id === oid); if(order) order.status = status; renderAdminOrders(); await fetch(API, {method:'POST', body:JSON.stringify({action:'update_order_status', store_id:partnerId, order_id:oid, status:status})}); toast(`Order ${status}`); }
    function toast(m,t='s'){const d=document.createElement('div');d.className=`p-4 px-6 rounded-xl shadow-2xl text-white text-sm font-bold animate-bounce ${t==='s'?'bg-gray-900':'bg-red-500'}`;d.innerHTML=t==='s'?`<i class="fas fa-check-circle mr-2"></i> ${m}`:`<i class="fas fa-exclamation-circle mr-2"></i> ${m}`;document.getElementById('toastBox').appendChild(d);setTimeout(()=>d.remove(),3000);}
    function setLoading(id,l){const b=document.getElementById(id);if(l){b.disabled=true;b.dataset.txt=b.innerText;b.innerHTML='<div class="spinner border-white"></div>';b.classList.add('opacity-75','cursor-not-allowed');}else{b.disabled=false;b.innerText=b.dataset.txt;b.classList.remove('opacity-75','cursor-not-allowed');}}
    function showSection(id){document.querySelectorAll('section').forEach(s=>s.classList.add('hidden-section'));document.getElementById(`view-${id}`).classList.remove('hidden-section'); window.scrollTo(0,0);}
    function showPublicHome() { document.getElementById('app-admin').classList.add('hidden-section'); document.getElementById('app-public').classList.remove('hidden-section'); showSection('home'); }
    function closeModal(id){document.getElementById(id).classList.add('hidden');}
    async function loadCustomerOrders() { showPublicHome(); document.getElementById('view-home').classList.add('hidden-section'); document.getElementById('view-myorders').classList.remove('hidden-section'); const div = document.getElementById('myOrdersList'); div.innerHTML='<div class="text-center py-20"><div class="spinner border-teal-600"></div><p class="mt-2 text-gray-500">Fetching your history...</p></div>'; if(!user) { div.innerHTML='<p class="text-center py-10">Please Login to view orders.</p>'; return; } const res = await fetch(`${API}?action=get_customer_orders&phone=${user.phone}`); const d = await res.json(); rawCustomerOrders = d.orders || []; filterMyOrders('Current'); }
    function filterMyOrders(type) { document.getElementById('tabMy-Current').className = type==='Current' ? 'pb-3 border-b-2 border-teal-600 font-bold text-teal-600 px-4 transition' : 'pb-3 border-b-2 border-transparent text-gray-500 hover:text-teal-600 px-4 transition'; document.getElementById('tabMy-History').className = type==='History' ? 'pb-3 border-b-2 border-teal-600 font-bold text-teal-600 px-4' : 'pb-3 border-b-2 border-transparent text-gray-500 hover:text-teal-600 px-4 transition'; const div = document.getElementById('myOrdersList'); div.innerHTML=''; const list = rawCustomerOrders.filter(o => type==='Current' ? (o.status==='Pending'||o.status==='Approved') : (o.status!=='Pending'&&o.status!=='Approved')); if(!list.length) return div.innerHTML=`<div class="text-center py-10 bg-white rounded-2xl border border-gray-100 shadow-sm"><i class="fas fa-box-open text-4xl text-gray-200 mb-3"></i><p class="text-gray-400">No ${type.toLowerCase()} orders.</p></div>`; list.forEach(o => { const items = JSON.parse(o.items).map(i=>i.name).join(', '); let badge = 'bg-yellow-100 text-yellow-800'; if(o.status==='Approved') badge='bg-blue-100 text-blue-800'; if(o.status==='Delivered') badge='bg-green-100 text-green-800'; if(o.status==='Cancelled') badge='bg-red-100 text-red-800'; div.innerHTML += `<div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg transition duration-300"><div class="flex justify-between items-center mb-4"><span class="font-mono text-gray-500 text-xs">#${o.order_id}</span><span class="${badge} px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest shadow-sm">${o.status}</span></div><div class="flex items-start gap-4 mb-4"><div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fas fa-store"></i></div><div><p class="font-bold text-gray-800 text-lg">${o.store_name}</p><a href="tel:${o.store_phone}" class="text-xs text-teal-600 font-bold hover:underline"><i class="fas fa-phone-alt mr-1"></i> ${o.store_phone}</a></div></div><div class="bg-gray-50 p-4 rounded-xl mb-4 text-sm text-gray-600 leading-relaxed border border-gray-100">${items}</div><div class="pt-4 border-t border-gray-100 flex justify-between items-center"><span class="text-xs text-gray-400">${new Date(o.date).toLocaleDateString()}</span><span class="text-xl font-extrabold text-gray-800">â‚¹${o.total}</span></div></div>`; }); }
    
    // AUTH
    function openAuth(type) { document.getElementById('authModal').classList.remove('hidden'); const c = document.getElementById('authContent'); if(type==='login') c.innerHTML=`<h3 class="font-bold text-2xl mb-1 text-gray-800">Welcome Back</h3><p class="text-sm text-gray-400 mb-6">Login to Nacsum</p><form onsubmit="doLogin(event)"><input name="phone" placeholder="Mobile Number" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 focus:bg-white transition"><input type="password" name="password" placeholder="Password" required class="w-full border border-gray-200 p-4 rounded-xl mb-6 outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 focus:bg-white transition"><button id="btnLogin" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg text-lg">Login</button></form><p class="mt-6 text-center text-sm text-gray-500">New? <span class="text-teal-600 font-bold cursor-pointer hover:underline" onclick="openAuth('register')">Create Account</span></p>`; if(type==='register') c.innerHTML=`<h3 class="font-bold text-2xl mb-1 text-gray-800">Create Account</h3><p class="text-sm text-gray-400 mb-6">Join Nacsum Biotech</p><form onsubmit="doReg(event)"><input name="name" placeholder="Full Name" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input name="phone" placeholder="Phone Number" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input type="password" name="password" placeholder="Set Password" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input name="address" placeholder="Delivery Address" required class="w-full border border-gray-200 p-4 rounded-xl mb-6 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><button id="btnReg" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg text-lg">Sign Up</button></form><p class="mt-6 text-center text-sm text-gray-500">Existing? <span class="text-teal-600 font-bold cursor-pointer hover:underline" onclick="openAuth('login')">Login</span></p>`; if(type==='partner') c.innerHTML=`<h3 class="font-bold text-2xl mb-1 text-gray-800">Partner Login</h3><p class="text-sm text-gray-400 mb-6">Manage your store</p><form onsubmit="doPLogin(event)"><input id="pidIn" placeholder="Store ID (e.g. MED-1001)" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 text-center uppercase tracking-widest font-mono text-lg bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input id="pPhoneIn" placeholder="Registered Mobile" required class="w-full border border-gray-200 p-4 rounded-xl mb-6 text-center text-lg bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><button id="btnPLogin" class="w-full bg-black text-white p-4 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg text-lg">Access Dashboard</button></form><div class="mt-8 pt-6 border-t border-gray-100 text-center"><p class="text-sm text-gray-500 mb-3">Want to join us?</p><form onsubmit="doPReg(event)" class="text-left hidden bg-gray-50 p-4 rounded-xl border border-gray-100 animate-fade-in-up" id="pRegForm"><input name="store_name" placeholder="Pharmacy Name" required class="w-full border p-3 rounded-lg mb-2"><input name="owner_name" placeholder="Owner Name" required class="w-full border p-3 rounded-lg mb-2"><input name="phone" placeholder="Phone" required class="w-full border p-3 rounded-lg mb-2"><input name="city" placeholder="City" required class="w-full border p-3 rounded-lg mb-2"><input name="address" placeholder="Full Address" required class="w-full border p-3 rounded-lg mb-3"><button id="btnPReg" class="w-full bg-teal-600 text-white p-3 rounded-lg font-bold">Register Now</button></form><button onclick="document.getElementById('pRegForm').classList.remove('hidden');this.classList.add('hidden')" class="text-teal-600 font-bold text-sm border border-teal-200 px-4 py-2 rounded-full hover:bg-teal-50 transition">Register New Store</button></div>`; }
    async function doLogin(e) { e.preventDefault(); setLoading('btnLogin',true); const d=Object.fromEntries(new FormData(e.target)); d.action='login_customer'; const res=await fetch(API,{method:'POST',body:JSON.stringify(d)}); const j=await res.json(); setLoading('btnLogin',false); if(j.status==='success'){ user=j.customer_data; localStorage.setItem('mediUser',JSON.stringify(user)); updateAuthUI(); closeModal('authModal'); toast('Welcome back'); } else toast('Invalid credentials','error'); }
    async function doReg(e) { e.preventDefault(); setLoading('btnReg',true); const d=Object.fromEntries(new FormData(e.target)); d.action='register_customer'; const res=await fetch(API,{method:'POST',body:JSON.stringify(d)}); const j=await res.json(); setLoading('btnReg',false); if(j.status==='success'){ user=j; localStorage.setItem('mediUser',JSON.stringify(user)); updateAuthUI(); closeModal('authModal'); toast('Account created'); } }
    async function doPLogin(e) { e.preventDefault(); setLoading('btnPLogin',true); const id = document.getElementById('pidIn').value; const phone = document.getElementById('pPhoneIn').value; const res = await fetch(API, { method:'POST', body:JSON.stringify({ action:'login_store', store_id: id, phone: phone }) }); const j=await res.json(); setLoading('btnPLogin',false); if(j.status==='success'){ partnerId=j.store_data.id; partnerName=j.store_data.name; localStorage.setItem('mediPartner', JSON.stringify({id: partnerId, name: partnerName})); loadAdminData(); closeModal('authModal'); toast('Logged in as Partner'); updateAuthUI(); } else { toast(j.message,'error'); } }
    async function doPReg(e) { e.preventDefault(); setLoading('btnPReg',true); const d=Object.fromEntries(new FormData(e.target)); d.action='register_store'; const res=await fetch(API,{method:'POST',body:JSON.stringify(d)}); const j=await res.json(); setLoading('btnPReg',false); if(j.status === 'error') { toast(j.message, 'error'); } else { closeModal('authModal'); document.getElementById('regSuccessId').innerText = j.store_id; document.getElementById('partnerSuccessModal').classList.remove('hidden'); } }
    function logoutUser(){ localStorage.removeItem('mediUser'); user=null; updateAuthUI(); showPublicHome(); toast('Logged Out'); }
    function logoutPartner(){ localStorage.removeItem('mediPartner'); partnerId=null; partnerName='Partner'; updateAuthUI(); showPublicHome(); toggleSidebar(); toast('Partner Logged Out'); }
</script>
</body>
</html>