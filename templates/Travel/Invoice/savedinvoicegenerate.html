<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solo2CEO Invoice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; background: #f1f5f9; }
    .invoice-box { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 850px; margin: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #d1d5db; padding: 10px; text-align: left; }
    th { background: #f3f4f6; }
    .btn { padding: 10px 15px; border-radius: 8px; margin: 5px; font-weight: bold; cursor: pointer; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-secondary { background: #16a34a; color: #fff; }
    .btn-warning { background: #eab308; color: #fff; }
    .btn-share { background: #f97316; color: #fff; }
    .status-paid { color: green; font-weight: bold; }
    .status-partial { color: orange; font-weight: bold; }
    .status-none { color: red; font-weight: bold; }
  </style>
</head>
<body class="p-6">

  <h2 class="text-center text-3xl font-bold mb-6 text-blue-700">Solo2CEO Invoice Generator</h2>

  <div id="invoicePreview" class="invoice-box">
    <div id="invoiceContent">
      <div class="flex justify-between items-center mb-6">
        <img src="./image/Solo2ceologo.png" alt="Solo2CEO Logo" class="h-14">
        <h1 class="text-3xl font-bold text-blue-800">INVOICE</h1>
      </div>

      <div class="mb-4">
        <h2 class="text-lg font-semibold">Billed To:</h2>
        <p id="pClientName" class="font-bold text-blue-700"></p>
        <p id="pClientAddress"></p>
        <p id="pClientPhone"></p>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <p><b>Invoice Number:</b> <span id="pInvoiceNo"></span></p>
        <p><b>Date:</b> <span id="pInvoiceDate"></span></p>
      </div>

      <table id="invoiceTable">
        <thead>
          <tr><th>Particulars</th><th>Amount</th></tr>
        </thead>
        <tbody id="invoiceBody"></tbody>
      </table>

      <div class="mt-4"><p id="pStatus"></p></div>

      <div class="mt-6">
        <h3 class="font-bold text-lg border-b pb-1">Payment Details</h3>
        <p><b>Account Holder:</b> Arman Khan</p>
        <p><b>Bank:</b> Au Small Finance Bank</p>
        <p><b>Account Number:</b> 2401252159545917</p>
        <p><b>IFSC:</b> AUBL0002521</p>
        <p><b>UPI ID:</b> 8850102255@ptaxis</p>
      </div>

      <p class="mt-8 text-center text-blue-700 font-semibold">Thank you for choosing Solo2CEO</p>
    </div>

    <div class="mt-6 text-center">
      <button onclick="downloadPDF()" class="btn btn-primary">Download PDF</button>
    </div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9Ra8blsDYX6QSSbywxRSlwNESSM8JQLjJdkomEt_oWkWryLVOAZxgUI-EH7eho9Ez-fQbNFcivmJH/pub?output=csv";
    const params = new URLSearchParams(window.location.search);
    const invoiceNo = params.get("invoiceNo");

    async function loadInvoice() {
      const res = await fetch(sheetUrl);
      const csv = await res.text();
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: result => {
          const data = result.data.find(r => r["Invoice No"] === invoiceNo);
          if (data) renderInvoice(data);
          else document.getElementById("invoiceContent").innerHTML = "<p class='text-center text-red-600'>Invoice not found!</p>";
        }
      });
    }

    function renderInvoice(d) {
      document.getElementById("pClientName").innerText = d["Client Name"];
      document.getElementById("pClientAddress").innerText = d["Client Address"];
      document.getElementById("pClientPhone").innerText = d["Client Phone"];
      document.getElementById("pInvoiceNo").innerText = d["Invoice No"];
      document.getElementById("pInvoiceDate").innerText = d["Invoice Date"];

      const price = parseFloat(d["Price (Rs)"]) || 0;
      const discount = parseFloat(d["Discount (Rs)"]) || 0;
      const advance = parseFloat(d["Advance (Rs)"]) || 0;
      const finalPayment = parseFloat(d["Final Payment (Rs)"]) || 0;
      const total = price - discount;
      const totalPaid = advance + finalPayment;
      const pending = total - totalPaid;

      let rows = `<tr><td>${d["Description"]}</td><td>Rs ${price}</td></tr>`;
      if (discount > 0) rows += `<tr><td>Discount</td><td>- Rs ${discount}</td></tr>`;
      rows += `<tr><td><b>Total</b></td><td><b>Rs ${total}</b></td></tr>`;

      let statusText = "";
      if (totalPaid === total) statusText = `<span class="status-paid">✅ Paid in Full</span>`;
      else if (advance > 0 && pending > 0) statusText = `<span class="status-partial">⚠️ Partial Payment</span>`;
      else statusText = `<span class="status-none">❌ Unpaid</span>`;

      document.getElementById("invoiceBody").innerHTML = rows;
      document.getElementById("pStatus").innerHTML = statusText;
    }

    function downloadPDF() {
      const element = document.getElementById("invoiceContent");
      html2pdf().set({
        filename: `${invoiceNo}.pdf`,
        margin: 10,
        html2canvas: { scale: 4 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      }).from(element).save();
    }

    loadInvoice();
  </script>
</body>
</html>
