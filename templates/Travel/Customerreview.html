<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Happy Travellers ‚Äî Success Stories</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Plus Jakarta Sans', sans-serif; }
  
  /* Animated Background */
  .animated-bg {
    background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
    background-size: 400% 400%;
    animation: gradient 15s ease infinite;
  }
  @keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Glassmorphism */
  .glass {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.5);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.6);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .glass-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* Star Rating */
  .rate { float: left; height: 46px; padding: 0 10px; }
  .rate:not(:checked) > input { position:absolute; top:-9999px; }
  .rate:not(:checked) > label { float:right; width:1em; overflow:hidden; white-space:nowrap; cursor:pointer; font-size:30px; color:#ccc; }
  .rate:not(:checked) > label:before { content: '‚òÖ '; }
  .rate > input:checked ~ label { color: #ffc700; }
  .rate:not(:checked) > label:hover,
  .rate:not(:checked) > label:hover ~ label { color: #deb217; }

  /* Animations */
  .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
  @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
  
  /* Skeleton Loading */
  .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
  @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body class="animated-bg min-h-screen text-slate-800">

<div class="max-w-7xl mx-auto p-4 lg:p-8">
  
  <header class="text-center mb-12 fade-in-up" style="animation-delay: 0.1s;">
    <div class="inline-block p-3 rounded-full glass mb-4 shadow-lg">
      <span class="text-4xl">‚úàÔ∏è</span>
    </div>
    <h1 class="text-5xl md:text-6xl font-extrabold text-white drop-shadow-md mb-3 tracking-tight">Happy Travellers</h1>
    <p class="text-white/90 text-lg md:text-xl font-medium">Real stories. Real visas. Real success.</p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
    
    <aside class="lg:col-span-4 lg:sticky lg:top-8 fade-in-up" style="animation-delay: 0.2s;">
      <div class="glass rounded-3xl p-6 md:p-8 shadow-2xl">
        <h2 class="text-2xl font-bold mb-1 text-pink-600">Share Your Story</h2>
        <p class="text-sm text-gray-500 mb-6">Did you get your visa? Tell the world!</p>
        
        <form id="reviewForm" class="space-y-5">
          <div>
            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Full Name</label>
            <input id="name" placeholder="e.g. Rahul Sharma" required class="w-full rounded-xl border-gray-200 bg-white/50 p-3 focus:ring-2 focus:ring-pink-500 focus:outline-none transition" />
          </div>
          
          <div>
            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Visa / Package</label>
            <input id="country" placeholder="e.g. UK Skilled Worker" required class="w-full rounded-xl border-gray-200 bg-white/50 p-3 focus:ring-2 focus:ring-pink-500 focus:outline-none transition" />
          </div>

          <div>
            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Rating</label>
            <div class="rate">
              <input type="radio" id="star5" name="rate" value="5" checked />
              <label for="star5" title="5 stars">5 stars</label>
              <input type="radio" id="star4" name="rate" value="4" />
              <label for="star4" title="4 stars">4 stars</label>
              <input type="radio" id="star3" name="rate" value="3" />
              <label for="star3" title="3 stars">3 stars</label>
              <input type="radio" id="star2" name="rate" value="2" />
              <label for="star2" title="2 stars">2 stars</label>
              <input type="radio" id="star1" name="rate" value="1" />
              <label for="star1" title="1 star">1 star</label>
            </div>
            <div class="clear-both"></div>
          </div>

          <div>
            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Experience</label>
            <textarea id="message" rows="3" placeholder="How was the service?" required class="w-full rounded-xl border-gray-200 bg-white/50 p-3 focus:ring-2 focus:ring-pink-500 focus:outline-none transition"></textarea>
          </div>

          <div>
            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Photos (Max 3)</label>
            <div class="relative border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-white/40 transition cursor-pointer" onclick="document.getElementById('photos').click()">
              <input id="photos" type="file" accept="image/*" multiple class="hidden" onchange="previewImages(this)"/>
              <p class="text-sm text-gray-500 pointer-events-none">Click to upload photos</p>
            </div>
            <div id="previewArea" class="flex gap-2 mt-2 overflow-x-auto"></div>
          </div>

          <button id="submitBtn" class="w-full py-3.5 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-pink-500 to-orange-400 hover:from-pink-600 hover:to-orange-500 transform hover:scale-[1.02] transition-all">
            Submit Review
          </button>
          
          <div id="status" class="text-center text-sm font-medium min-h-[20px]"></div>
        </form>
      </div>
    </aside>

    <main class="lg:col-span-8 space-y-6">
      
      <div class="glass rounded-2xl p-4 flex items-center gap-3 fade-in-up" style="animation-delay: 0.3s;">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        <input type="text" id="searchInput" placeholder="Search by country or name..." class="bg-transparent w-full focus:outline-none text-lg placeholder-gray-500" onkeyup="filterReviews()">
      </div>

      <div id="reviewsGrid" class="columns-1 md:columns-2 gap-6 space-y-6">
        <div class="glass-card rounded-3xl p-5 break-inside-avoid mb-6">
          <div class="flex gap-3 items-center mb-4">
            <div class="w-12 h-12 rounded-full skeleton"></div>
            <div class="space-y-2">
              <div class="h-4 w-32 skeleton rounded"></div>
              <div class="h-3 w-20 skeleton rounded"></div>
            </div>
          </div>
          <div class="h-32 w-full skeleton rounded-xl mb-3"></div>
          <div class="h-4 w-full skeleton rounded mb-2"></div>
          <div class="h-4 w-2/3 skeleton rounded"></div>
        </div>
        <div class="glass-card rounded-3xl p-5 break-inside-avoid mb-6">
          <div class="flex gap-3 items-center mb-4">
            <div class="w-12 h-12 rounded-full skeleton"></div>
            <div class="space-y-2">
              <div class="h-4 w-32 skeleton rounded"></div>
              <div class="h-3 w-20 skeleton rounded"></div>
            </div>
          </div>
          <div class="h-4 w-full skeleton rounded mb-2"></div>
          <div class="h-4 w-full skeleton rounded mb-2"></div>
          <div class="h-4 w-1/2 skeleton rounded"></div>
        </div>
      </div>

    </main>
  </div>

  <footer class="mt-16 text-center text-white/80 text-sm font-light">
    &copy; 2024 Happy Travellers. Reviews are moderated before publishing.
  </footer>
</div>

<div id="imageModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
  <img id="modalImg" class="max-w-full max-h-screen rounded-lg shadow-2xl transform scale-95 transition-transform duration-300" src="" />
</div>

<script>
const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwW_sh_7YEWRyh9mlSqFnl9W6PcWh94bRIOte2zIClNlpuBstNhO3N9WYRqfeJ_f3w/exec';

// --- UTILITIES ---

const statusEl = document.getElementById('status');
const grid = document.getElementById('reviewsGrid');
let allReviews = [];

function setStatus(msg, type = 'neutral') {
  statusEl.innerHTML = msg;
  statusEl.className = `text-center text-sm font-medium mt-3 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600'}`;
}

// 1. AGGRESSIVE COMPRESSION (To fit inside Google Sheet Cell limit)
function compressImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        // Reduced to 400px to ensure it fits in a Sheet cell (Max 50k chars)
        const MAX_WIDTH = 400; 
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        // Low quality JPEG (0.6) to keep string short
        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
      }
    }
  });
}

function previewImages(input) {
  const area = document.getElementById('previewArea');
  area.innerHTML = '';
  if (input.files) {
    [...input.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'w-16 h-16 object-cover rounded-lg border border-gray-200';
        area.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }
}

// 2. SMART URL PARSER (Handles Drive Links & Broken Base64)
function getSafeImageUrl(rawUrl) {
  if (!rawUrl) return 'https://via.placeholder.com/400x300?text=No+Image';
  
  // If it's a Google Drive Link, convert to View Link
  if (rawUrl.includes('drive.google.com')) {
    const idMatch = rawUrl.match(/[-\w]{25,}/);
    if (idMatch) {
      // Use the thumbnail endpoint which is more reliable than export=view
      return `https://lh3.googleusercontent.com/d/${idMatch[0]}=s800`;
    }
  }
  return rawUrl;
}

// --- SUBMIT LOGIC ---

document.getElementById('reviewForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const btn = document.getElementById('submitBtn');
  const originalBtnText = btn.innerText;
  
  btn.disabled = true;
  btn.innerHTML = `Processing...`;
  setStatus('Compressing & Uploading...', 'neutral');

  try {
    const name = document.getElementById('name').value.trim();
    const country = document.getElementById('country').value.trim();
    const message = document.getElementById('message').value.trim();
    const rating = document.querySelector('input[name="rate"]:checked')?.value || "5";
    
    // Process Images
    const fileInput = document.getElementById('photos');
    let imagesData = [];
    if(fileInput.files.length > 0) {
      // Limit to 1 image for now to prevent crashing the script
      imagesData = await Promise.all([...fileInput.files].slice(0, 1).map(f => compressImage(f)));
    }

    const payload = { name, country, message: `(${rating}‚òÖ) ${message}`, images: imagesData };

    await fetch(API_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    setStatus('üéâ Submitted! It will appear after approval.', 'success');
    document.getElementById('reviewForm').reset();
    document.getElementById('previewArea').innerHTML = '';
    
  } catch (err) {
    console.error(err);
    setStatus('‚ùå Error. File might be too large.', 'error');
  } finally {
    btn.disabled = false;
    btn.innerText = originalBtnText;
  }
});

// --- RENDER LOGIC ---

async function loadReviews() {
  try {
    const res = await fetch(API_ENDPOINT + '?action=getReviews');
    const data = await res.json();

    if (Array.isArray(data.reviews)) {
      allReviews = data.reviews.reverse();
      renderGrid(allReviews);
    } else {
      grid.innerHTML = `<div class="text-center text-white/80 col-span-full py-10">No reviews found.</div>`;
    }
  } catch (err) {
    grid.innerHTML = `<div class="text-center text-white/80 col-span-full py-10">Loading...</div>`;
  }
}

function renderGrid(reviews) {
  grid.innerHTML = '';
  
  if(reviews.length === 0){
     grid.innerHTML = `<div class="text-center text-white/60 col-span-full pt-10">No matching reviews.</div>`;
     return;
  }

  reviews.forEach((r, i) => {
    let images = [];
    try { images = Array.isArray(r.image) ? r.image : JSON.parse(r.image); } 
    catch(e){ if(r.image) images = [r.image]; }

    // Clean Message
    let rating = 5;
    let cleanMsg = r.message || "";
    const ratingMatch = cleanMsg.match(/^\((\d)‚òÖ\)\s*/);
    if(ratingMatch) {
      rating = parseInt(ratingMatch[1]);
      cleanMsg = cleanMsg.replace(/^\((\d)‚òÖ\)\s*/, '');
    }

    // Stars
    const starsHtml = Array(5).fill(0).map((_, idx) => 
      `<span class="${idx < rating ? 'text-yellow-400' : 'text-gray-200'}">‚òÖ</span>`
    ).join('');

    // Avatar Color
    const colors = ['bg-pink-100 text-pink-600', 'bg-blue-100 text-blue-600', 'bg-purple-100 text-purple-600', 'bg-orange-100 text-orange-600'];
    const colorClass = colors[r.name.length % colors.length];

    // Card HTML
    const card = document.createElement('div');
    card.className = 'glass-card rounded-3xl p-5 break-inside-avoid mb-6 fade-in-up';
    card.style.animationDelay = `${i * 0.05}s`;

    let mediaHtml = '';
    if(images.length > 0 && images[0]) {
      const safeUrl = getSafeImageUrl(images[0]);
      mediaHtml = `
        <div class="relative overflow-hidden rounded-xl mb-4 group cursor-pointer bg-gray-100" onclick="openModal('${safeUrl}')">
          <img src="${safeUrl}" 
               class="w-full h-48 object-cover transform group-hover:scale-105 transition duration-500" 
               loading="lazy" 
               onerror="this.onerror=null; this.src='https://via.placeholder.com/400x300?text=Image+Error'; this.parentElement.style.height='auto';"
          />
        </div>`;
    }

    card.innerHTML = `
      <div class="flex items-center gap-3 mb-3 border-b border-gray-100 pb-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${colorClass}">
          ${r.name ? r.name.charAt(0).toUpperCase() : 'U'}
        </div>
        <div>
          <h3 class="font-bold text-gray-800 leading-tight">${escapeHtml(r.name)}</h3>
          <p class="text-xs text-pink-500 font-semibold uppercase tracking-wide">${escapeHtml(r.country)}</p>
        </div>
      </div>
      
      ${mediaHtml}
      
      <div class="text-lg mb-2">${starsHtml}</div>
      <p class="text-gray-600 text-sm leading-relaxed">${escapeHtml(cleanMsg)}</p>
      <div class="mt-4 text-xs text-gray-400 text-right">${escapeHtml(r.date || '')}</div>
    `;

    grid.appendChild(card);
  });
}

// Search Filter
function filterReviews() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allReviews.filter(r => 
    (r.name && r.name.toLowerCase().includes(query)) || 
    (r.country && r.country.toLowerCase().includes(query))
  );
  renderGrid(filtered);
}

// Modal
function openModal(src) {
  const modal = document.getElementById('imageModal');
  const img = document.getElementById('modalImg');
  img.src = src;
  modal.classList.remove('hidden');
}

function escapeHtml(s) { if (!s) return ''; return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'); }

loadReviews();
</script>
</body>
</html>