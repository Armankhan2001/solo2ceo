<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Itinerary View</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin:0; padding:30px; color:#333; }
    .container { max-width: 900px; margin:auto; background:#fff; padding:30px; border-radius:18px; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
    .logo { text-align:center; margin-bottom:20px; }
    .logo img { width:140px; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.2); }
    .title { text-align:center; font-size:2rem; font-weight:bold; color:#0077b6; text-shadow:0 2px 3px rgba(0,0,0,0.2); margin-bottom:30px; }
    h2.section { background:#ffeb3b; padding:6px 14px; font-size:1.2rem; font-weight:bold; margin:30px 0 15px; display:inline-block; border-radius:6px; }
    .day { padding:15px; margin-bottom:20px; border-left:4px solid #0077b6; background:#f8faff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .day strong { font-size:1.1rem; color:#e63946; display:block; margin-bottom:6px; }
    .day ul { margin:0; padding-left:20px; color:#555; }
    table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:10px; overflow:hidden; }
    table th, table td { border:1px solid #ccc; padding:10px; text-align:center; }
    table th { background:#0077b6; color:#fff; font-weight:600; }
    .cost-row { background:#ffe0e0; font-weight:bold; text-align:center; padding:12px; margin-top:8px; border-radius:8px; font-size:1rem; }
    .info-list { background:#fafafa; padding:15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .info-list ul { margin:0; padding-left:20px; }
    .info-list li { margin-bottom:6px; line-height:1.5; }
    .btn-group { text-align:center; margin-top:30px; }
    .btn { background:#0077b6; color:white; padding:12px 20px; border-radius:10px; text-decoration:none; font-weight:600; margin:10px; display:inline-flex; align-items:center; gap:8px; transition: background 0.3s; }
    .btn:hover { background:#023e8a; }
  </style>
</head>
<body>

<div class="container" id="preview">
  <div class="logo" id="logoBox"></div>
  <div class="title" id="packageTitle">PACKAGE TITLE</div>

  <h2 class="section">DAYWISE ITINERARY</h2>
  <div id="itinerary"></div>

  <h2 class="section">HOTEL OPTIONS :</h2>
  <table>
    <thead>
      <tr><th>CITY NAME</th><th>HOTEL NAME</th><th>NO. OF NIGHT</th><th>MEAL PLAN</th></tr>
    </thead>
    <tbody id="hotelTable"></tbody>
  </table>
  <div class="cost-row" id="totalCost"></div>

  <h2 class="section">INCLUSIONS</h2>
  <div class="info-list" id="inclusions"></div>

  <h2 class="section">EXCLUSIONS</h2>
  <div class="info-list" id="exclusions"></div>

  <h2 class="section" id="noteHeader" style="display:none;">NOTE</h2>
  <div class="info-list" id="noteContent" style="display:none;"></div>
</div>

<div class="btn-group">
  <button class="btn" id="downloadBtn"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
  <button class="btn" id="shareBtn"><i class="fa-solid fa-share-nodes"></i> Share</button>
</div>

<script>
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKWpvBUstFi-xtd__NDN3MqnMBb04fzGfAb9Ce27ao0gMGejfXqCp9V_Dh4G_Z8ungzPf4MHsy0hkx/pub?output=csv";
  const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(sheetUrl);
  const params = new URLSearchParams(window.location.search);
  const packageName = params.get("package");
  let currentPkg = null;

  Papa.parse(proxyUrl, { download:true, header:true,
    complete:function(results){
      const allData = results.data;
      currentPkg = allData.find(r => r['Package Name'] === packageName);

      if(!currentPkg){ document.getElementById("preview").innerHTML = "<p>Package not found.</p>"; return; }

      if(currentPkg["Logo"]){ document.getElementById("logoBox").innerHTML = `<img src="${currentPkg["Logo"]}" alt="Logo">`; }
      document.getElementById("packageTitle").innerText = currentPkg["Package Name"] + " â€“ " + currentPkg["Duration"];

      // Itinerary
      if(currentPkg["Itinerary"]){
        const days = currentPkg["Itinerary"].split(/Day\s*\d+:/i);
        let matches = currentPkg["Itinerary"].match(/Day\s*\d+:/gi) || [];
        let formatted = "";
        for(let i=1;i<days.length;i++){
          let lines = days[i].trim().split("\n").filter(l=>l);
          formatted += `<div class="day"><strong>${matches[i-1]} ${lines[0]||""}</strong><ul>` 
                       + lines.map(l=>`<li>${l}</li>`).join("") 
                       + "</ul></div>";
        }
        document.getElementById("itinerary").innerHTML = formatted;
      }

      // Hotels
      if(currentPkg["Hotels"]){
        let rows = currentPkg["Hotels"].split("\n").map(h=>{
          let [city,hotel,nights,meals] = h.split("|");
          return `<tr><td>${city||""}</td><td>${hotel||""}</td><td>${nights||""}</td><td>${meals||""}</td></tr>`;
        }).join("");
        document.getElementById("hotelTable").innerHTML = rows;
      }

      document.getElementById("totalCost").innerText = currentPkg["Price"]||"";

      // Inclusions
      document.getElementById("inclusions").innerHTML = currentPkg["Inclusions"] 
        ? "<ul>" + currentPkg["Inclusions"].split("\n").map(i=>`<li>${i}</li>`).join("") + "</ul>" 
        : "Not specified.";

      // Exclusions
      document.getElementById("exclusions").innerHTML = currentPkg["Exclusions"] 
        ? "<ul>" + currentPkg["Exclusions"].split("\n").map(i=>`<li>${i}</li>`).join("") + "</ul>" 
        : "Not specified.";

      // Note
        if(currentPkg["Note"] && currentPkg["Note"].trim() !== ""){
        document.getElementById("noteHeader").style.display = "block";
        document.getElementById("noteContent").style.display = "block";
        document.getElementById("noteContent").innerHTML = "<ul>" 
            + currentPkg["Note"].split("\n").map(i=>`<li>${i}</li>`).join("") 
            + "</ul>";
        } else {
        document.getElementById("noteHeader").style.display = "none";
        document.getElementById("noteContent").style.display = "none";
        }

    }
  });

  // Multi-page PDF export using html2canvas + jsPDF
  document.getElementById("downloadBtn").addEventListener("click", () => {
    if(!currentPkg) return;
    const container = document.getElementById("preview");

    html2canvas(container, { scale:2 }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "pt", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth;
      const imgHeight = canvas.height * imgWidth / canvas.width;

      let heightLeft = imgHeight;
      let position = 0;

      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while(heightLeft > 0){
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      pdf.save(`${currentPkg["Package Name"]}.pdf`);
    });
  });

  // Share button (copy URL with package param)
  document.getElementById("shareBtn").addEventListener("click", () => {
    const shareUrl = window.location.href;
    navigator.clipboard.writeText(shareUrl).then(()=>{
      alert("Share link copied to clipboard!");
    }).catch(()=>{ alert("Failed to copy link."); });
  });

</script>
</body>
</html>
