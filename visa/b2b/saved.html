<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Saved Itineraries — AsToursInternational</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .spinner {
    border: 4px solid rgba(0,0,0,0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: #4f46e5;
    animation: spin 1s linear infinite;
    margin: auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .itinerary-card:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    transform: translateY(-2px);
    transition: all 0.2s ease-in-out;
  }
</style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

<header class="bg-indigo-700 text-white py-4 px-6 shadow sticky top-0 z-40">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <h1 class="text-xl font-bold">📋 Saved Itineraries</h1>
    <a href="generate.html" class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/20">🔙 Back to Generator</a>
  </div>
</header>

<main class="max-w-6xl mx-auto p-6">

<div class="bg-white rounded-2xl shadow p-6 mb-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <h2 class="text-lg font-bold text-indigo-700 mb-2">All Saved Itineraries ✈️</h2>
    <input type="text" id="searchInput" placeholder="🔍 Search by name, country, or confirmation..." 
           class="border rounded px-3 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
  </div>
</div>

<div id="itineraryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  <div class="col-span-full flex justify-center py-10" id="loadingIndicator">
    <div class="spinner"></div>
  </div>
</div>

</main>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyHWuCVyvT5qf5IjDSKQxHX7VdEGH_LU6VSCTOmz0GtjAuQtYesdy4qbyq6Re-sgylPPQ/exec";
let itineraries = [];
let logoData = "";

// Get flag emoji from 2-letter ISO
function getFlagEmoji(countryCode) {
    if(!countryCode) return '🏳️';
    return countryCode.toUpperCase().replace(/./g, char => 
        String.fromCodePoint(127397 + char.charCodeAt())
    );
}

// Render itinerary cards
function renderItineraries(data){
    const listEl = document.getElementById('itineraryList');
    listEl.innerHTML = '';
    if(!data.length){
        listEl.innerHTML = '<p class="col-span-full text-gray-500 text-center py-10">No saved itineraries found.</p>';
        return;
    }

    data.forEach(d=>{
        const div = document.createElement('div');
        div.className = 'itinerary-card cursor-pointer border rounded-xl p-4 bg-white hover:bg-gray-50';
        const flag = getFlagEmoji(d.countryISO || '');
        const passengers = d.passengerDetails?.join(', ') || '';
        div.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-indigo-700 text-lg">${flag} ${d.tourCountry || 'Unknown Country'}</h3>
            <span class="text-sm font-mono text-gray-500">#${d.confirmationNo || 'N/A'}</span>
          </div>
          <p class="text-gray-700 mb-1">👤 ${passengers}</p>
          <p class="text-gray-500 text-sm mb-2">🗓 ${d.startDate ? d.startDate + ' → ' + d.endDate : 'Dates N/A'}</p>
          <div class="flex justify-end gap-2">
            <button class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">Preview ➡️</button>
            <button class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 text-sm">✏️ Edit</button>
          </div>
        `;

        // Preview button opens preview.html
        div.querySelector('button:nth-child(1)').onclick = ()=>{
            const jsonStr = encodeURIComponent(JSON.stringify(d));
            window.open(`preview.html?data=${jsonStr}`, '_blank');
        };

        // Edit button opens Availableitineraries.html and populates form
        div.querySelector('button:nth-child(2)').onclick = ()=>{
            localStorage.setItem('editItinerary', JSON.stringify(d));
            window.open('Availableitineraries.html', '_blank');
        };

        listEl.appendChild(div);
    });
}

// Filter
function filterItineraries(term){
    const filtered = itineraries.filter(d=>{
        term = term.toLowerCase();
        const passengers = (d.passengerDetails || []).join(' ').toLowerCase();
        return (d.tourCountry?.toLowerCase().includes(term) || 
                d.confirmationNo?.toLowerCase().includes(term) ||
                passengers.includes(term));
    });
    renderItineraries(filtered);
}

// Load saved itineraries
async function loadItineraries(){
    const listEl = document.getElementById('itineraryList');
    const loadingEl = document.getElementById('loadingIndicator');
    loadingEl.style.display = 'flex';
    try{
        const res = await fetch(`${WEB_APP_URL}?action=list`);
        const json = await res.json();
        itineraries = json.data || [];
        filterItineraries(''); // render all
    } catch(e){
        console.error(e);
        listEl.innerHTML = `<p class="col-span-full text-red-500 text-center py-10">Failed to load itineraries: ${e.message}</p>`;
    } finally {
        loadingEl.style.display = 'none';
    }
}

// Search input
document.getElementById('searchInput').addEventListener('input', (e)=>{
    filterItineraries(e.target.value);
});

// Initial load
loadItineraries();
</script>


</body>
</html>
