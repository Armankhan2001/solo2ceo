<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Itinerary Preview — AsToursInternational</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
.pdf-page {
    width: 210mm;
    min-height: 297mm;
    padding: 20mm;
    margin: auto;
    box-sizing: border-box;
    background: white;
    font-family: Inter, Arial, Helvetica, sans-serif;
    color: #111827;
}
.brand-logo { max-height: 100px; object-fit: contain; display: block; margin-bottom: 10px; }
.section-title { font-weight: 700; color: #4f46e5; margin-top: 20px; margin-bottom: 8px; }
.table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.table th, .table td { padding: 8px; border: 1px solid #d1d5db; vertical-align: top; word-break: break-word; }
.table th { background-color: #f3f4f6; text-align: left; }
.date-cell { white-space: nowrap; } /* prevents date overflow */
.footer { margin-top: 20px; font-size: 11px; color: #6b7280; text-align: center; }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8">

<div class="max-w-4xl w-full bg-white shadow rounded-xl p-6">

<div class="flex justify-between items-center mb-4">
    <div id="logoWrapper"></div>
</div>
<hr class="mb-4 border-gray-300">

<div id="confirmationText" class="mb-2 font-semibold"></div>

<div id="greeting" class="text-sm mb-4 whitespace-pre-line"></div>

<div id="passengers" class="text-sm mb-4"></div>

<div id="hotelsSection" class="mb-4"></div>

<div id="scheduleSection" class="mb-4"></div>

<!-- Company info at the bottom -->
<div id="companyInfo" class="text-sm mt-6 border-t pt-4"></div>

<div class="flex gap-2 mt-4">
<button id="downloadBtn" class="bg-emerald-600 text-white px-4 py-2 rounded">Download PDF</button>
<button onclick="window.history.back()" class="bg-gray-600 text-white px-4 py-2 rounded">Back</button>
</div>

<div class="footer">Generated by AsToursInternational</div>
</div>

<script>
// Get data from URL
function getDataFromURL() {
    const params = new URLSearchParams(window.location.search);
    const dataStr = params.get('data');
    if(!dataStr) return null;
    try {
        return JSON.parse(decodeURIComponent(dataStr));
    } catch(e) {
        console.error(e);
        return null;
    }
}

// Escape HTML
function escapeHtml(text){
    if(!text && text!==0) return '';
    return String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

// Format date
function formatDate(d){
    if(!d) return '';
    const dt = new Date(d);
    const dd = ('0' + dt.getDate()).slice(-2);
    const mm = ('0' + (dt.getMonth()+1)).slice(-2);
    const yyyy = dt.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
}

// Build preview
function buildPreview(data){
    // Logo
    const logoWrapper = document.getElementById('logoWrapper');
    logoWrapper.innerHTML = '';
    if(data.logoData){
        const img = document.createElement('img');
        img.src = data.logoData;
        img.className = 'brand-logo';
        logoWrapper.appendChild(img);
    } else if(data.logoUrl){
        const img = document.createElement('img');
        img.src = data.logoUrl;
        img.className = 'brand-logo';
        logoWrapper.appendChild(img);
    }

    // Confirmation text
    document.getElementById('confirmationText').innerText = `Confirmation No.: ${data.confirmationNo || ''}`;

    // Greeting
    let greeting = '';
    let hasMr=false, hasMrs=false;
    (data.passengerDetails||[]).forEach(p=>{
        if(p.toLowerCase().includes('mr')) hasMr=true;
        if(p.toLowerCase().includes('mrs')) hasMrs=true;
    });
    greeting = (hasMr && hasMrs) ? "Dear Sir/Ma’am," : hasMr ? "Dear Sir," : "Dear Sir/Ma’am,";
    greeting += `\nGreetings from ${data.companyName||''}!\nAs per our discussion, we are pleased to confirm the below ${data.tourCountry||'tour'} for you.`;
    document.getElementById('greeting').innerText = greeting;

    // Passengers
    if(data.passengerDetails && data.passengerDetails.length){
        document.getElementById('passengers').innerHTML = `<b>Passenger Details:</b><br>${data.passengerDetails.map(p=>escapeHtml(p)).join('<br>')}`;
    }

    // Hotels
    let hotelsHtml = '';
    if(data.hotels && data.hotels.length){
        hotelsHtml = `<div class="section-title">Hotels / Stays</div><table class="table">
        <thead><tr>
        <th>City</th><th>Check In</th><th>Check Out</th><th>Hotel</th>`;
        if(data.hotels.some(h=>h.contact)) hotelsHtml += `<th>Contact</th>`;
        hotelsHtml += `</tr></thead><tbody>`;
        data.hotels.forEach(h=>{
            hotelsHtml += `<tr>
            <td>${escapeHtml(h.city)}</td>
            <td class="date-cell">${formatDate(h.checkin)}</td>
            <td class="date-cell">${formatDate(h.checkout)}</td>
            <td>${escapeHtml(h.hotel)}</td>`;
            if(data.hotels.some(h=>h.contact)) hotelsHtml += `<td>${escapeHtml(h.contact||'')}</td>`;
            hotelsHtml += `</tr>`;
        });
        hotelsHtml += `</tbody></table>`;
    }
    document.getElementById('hotelsSection').innerHTML = hotelsHtml;

    // Schedule
    let rows = [];
    if(data.hotels) data.hotels.forEach(h=>{
        let current = new Date(h.checkin);
        const end = new Date(h.checkout);
        while(current <= end){
            rows.push({date: formatDate(current), detail:`Stay in ${h.city} — ${h.hotel}`});
            current.setDate(current.getDate()+1);
        }
    });
    if(data.manualDays) data.manualDays.forEach(md=>{
        if(!md.date) return;
        const content = (md.title ? md.title+' — ' : '') + (md.activities||'');
        const idx = rows.findIndex(r=>r.date===formatDate(md.date));
        if(idx>=0) rows[idx].detail = content;
        else rows.push({date:formatDate(md.date),detail:content});
    });
    rows.sort((a,b)=>a.date.localeCompare(b.date));
    let scheduleHtml = '';
    if(rows.length){
        scheduleHtml = `<div class="section-title">Day-wise Schedule</div><table class="table">
        <thead><tr><th>Date</th><th>Activity</th></tr></thead><tbody>`;
        rows.forEach(r=>{
            scheduleHtml += `<tr><td class="date-cell">${r.date}</td><td>${escapeHtml(r.detail)}</td></tr>`;
        });
        scheduleHtml += `</tbody></table>`;
    }
    document.getElementById('scheduleSection').innerHTML = scheduleHtml;

    // Company info at bottom
    const companyHtml = `
    ${data.companyName ? `<b>${escapeHtml(data.companyName)}</b><br>` : ''}
    ${data.companyAddress ? `${escapeHtml(data.companyAddress)}<br>` : ''}
    ${data.companyEmail ? `Email: ${escapeHtml(data.companyEmail)}<br>` : ''}
    ${data.companyWebsite ? `Website: ${escapeHtml(data.companyWebsite)}<br>` : ''}
    `;
    document.getElementById('companyInfo').innerHTML = companyHtml;
}

// Download PDF
// Download PDF
function downloadPDF(){
    const element = document.querySelector('.max-w-4xl');

    // Use html2pdf with optimized settings
    const opt = {
        margin: [10,10,10,10],
        filename: `Itinerary_${document.getElementById('confirmationText').innerText.replace('Confirmation No.: ','')||'confirmation'}.pdf`,
        image: {type:'jpeg', quality:1.0},
        html2canvas: {
            scale: 3,          // higher scale for better quality
            useCORS: true,     // load external images
            logging: false,
            scrollY: 0         // prevent canvas shift
        },
        jsPDF: {unit:'mm', format:'a4', orientation:'portrait'}
    };

    html2pdf().set(opt).from(element).save();
}

// Attach event
document.getElementById('downloadBtn').addEventListener('click', downloadPDF);

// Initialize
const data = getDataFromURL();
if(data){
    buildPreview(data);
} else {
    document.body.innerHTML = '<div class="text-center text-red-500 mt-20">No itinerary data found!</div>';
}

document.getElementById('downloadBtn').addEventListener('click', downloadPDF);

</script>
</body>
</html>
