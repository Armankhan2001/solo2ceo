<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AsTours International— Global Visa All Sources</title>
  <link rel="preconnect" href="https://flagcdn.com" crossorigin>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --muted:#94a3b8; --text:#e2e8f0; --brand:#6366f1; --chip:#1e293b; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020, #101935 40%, #0b1020);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:50;background:#0b1220aa;backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .bar{max-width:1200px;margin:auto;display:grid;grid-template-columns:1fr;gap:12px;padding:14px 16px}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:18px;background:white;display:grid;place-items:center;font-weight:800}
    h1{font-size:20px;margin:0}
    .controls{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:780px){ .bar{grid-template-columns:auto 1fr auto} .controls{grid-template-columns:2fr 1fr 1fr 1fr} }
    input,select{width:100%;background:#0c1426;border:1px solid #1f2a44;color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    input:focus,select:focus{border-color:#334155;box-shadow:0 0 0 3px #6366f155}

    main{max-width:1200px;margin:0 auto;padding:18px 16px}
    #status{color:var(--muted);font-size:13px;margin-bottom:10px}
    #cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}

    .card{background:linear-gradient(180deg,#0a0f1f,#0c1426 60%,#0a0f1f);border:1px solid #1f2a44;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:0 6px 20px #00000040}
    .card:hover{border-color:#334155;box-shadow:0 8px 28px #00000070}
    .card-head{display:flex;gap:10px;align-items:center}
    .flag{width:42px;height:30px;border-radius:6px;object-fit:cover;border:1px solid #1f2a44;background:#0b1220}
    .country{font-weight:700;font-size:16px;margin:0}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:11px;color:#cbd5e1;background:var(--chip);border:1px solid #1f2a44;padding:4px 8px;border-radius:999px}
    .chip.type{background:#13241a;border-color:#1a2e23;color:#bde9d5}
    .sources{color:var(--muted);font-size:11px}
    .btn{background:#0e1729;border:1px solid #1f2a44;color:#e5e7eb;border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn:hover{border-color:#334155}

    dialog{border:none;border-radius:16px;padding:0;width:min(880px,92vw);background:#0b1220;color:var(--text)}
    dialog::backdrop{background:#0008}
    .dlg-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2a44}
    .dlg-body{padding:16px;max-height:70vh;overflow:auto}
    .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.grid-2{grid-template-columns:1fr 1fr}}
    .vt{border:1px solid #1f2a44;border-radius:12px;padding:12px;background:#0c1426}
    .vt h4{margin:0;font-size:14px}
    dl{display:grid;grid-template-columns:auto 1fr;gap:8px 12px;margin:8px 0 0}
    dt{color:#93a3b8}
    details{border:1px dashed #1f2a44;border-radius:12px;padding:10px;margin-top:12px}
    details>summary{cursor:pointer;color:#cbd5e1}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #1f2a44;border-radius:999px;background:#0e1729;color:#d1d5db;font-size:12px}
    .footer{padding:10px 16px;border-top:1px solid #1f2a44;color:#93a3b8;font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">
        <a class="navbar-brand text-primary fw-bold" href="#">
        <img src="../image/astourlogo.png" alt="ASTours Logo" class="logo">
      </a>
        <h1>Global Visa</h1>
      </div>
      <div class="controls">
        <input id="searchInput" placeholder="Search country…" />
        <select id="regionFilter"><option value="">All Regions</option></select>
        <select id="visaTypeFilter"><option value="">All Visa Types</option></select>
        <select id="sourceFilter"><option value="">All Sources</option></select>
      </div>
      <div>
        <button id="resetBtn" class="btn" title="Clear filters">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <div id="status">Loading…</div>
    <div id="cards"></div>
  </main>

  <dialog id="detailDialog">
    <div class="dlg-head">
      <div style="display:flex;align-items:center;gap:10px">
        <img id="dlgFlag" class="flag" alt="flag" />
        <div>
          <div id="dlgTitle" class="country">Country</div>
          <div id="dlgRegions" class="chips"></div>
        </div>
      </div>
      <form method="dialog"><button class="btn">Close</button></form>
    </div>
    <div id="dlgBody" class="dlg-body"></div>
    <div class="footer"><span id="dlgSources"></span></div>
  </dialog>

  <script>
  // ================== CONFIG ==================
  const SOURCES = [
    { url: 'https://raw.githubusercontent.com/Armankhan2001/schenzendatabase/refs/heads/master/schengen.json', tag: 'Schengen', fallbackRegion: 'Schengen' },
    { url: 'https://raw.githubusercontent.com/Armankhan2001/evisadatabse/refs/heads/master/final_visa_data.json', tag: 'E-Visa', fallbackRegion: 'E-Visa' },
    { url: 'https://raw.githubusercontent.com/Armankhan2001/visaDatabase/refs/heads/main/visaDatabase.json', tag: 'Global', fallbackRegion: 'Global' },
    { url: 'https://raw.githubusercontent.com/Armankhan2001/Gcc_database/refs/heads/master/freevisacountries.json', tag: 'Visa-Free', fallbackRegion: 'GCC' },
    { url: 'https://raw.githubusercontent.com/Armankhan2001/Gcc_database/refs/heads/master/gcc.json', tag: 'GCC', fallbackRegion: 'GCC' }
  ];

  // A comprehensive ISO alpha-2 mapping for flagcdn (lowercase)
  // NOTE: add/adjust aliases to match your data naming.
  const ISO2 = {
    "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Antigua and Barbuda":"ag","Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at","Azerbaijan":"az",
    "Bahamas":"bs","Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj","Bhutan":"bt","Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn","Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi",
    "Cabo Verde":"cv","Cambodia":"kh","Cameroon":"cm","Canada":"ca","Central African Republic":"cf","Chad":"td","Chile":"cl","China":"cn","Colombia":"co","Comoros":"km","Congo":"cg","Costa Rica":"cr","Côte d'Ivoire":"ci","Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czech Republic":"cz","Czechia":"cz",
    "Democratic Republic of the Congo":"cd","Denmark":"dk","Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Dubai":"ae",
    "Ecuador":"ec","Egypt":"eg","El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee","Eswatini":"sz","Ethiopia":"et",
    "Fiji":"fj","Finland":"fi","France":"fr",
    "Gabon":"ga","Gambia":"gm","Georgia":"ge","Germany":"de","Ghana":"gh","Greece":"gr","Grenada":"gd","Guatemala":"gt","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy",
    "Haiti":"ht","Honduras":"hn","Hungary":"hu",
    "Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq","Ireland":"ie","Israel":"il","Italy":"it",
    "Jamaica":"jm","Japan":"jp","Jordan":"jo",
    "Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki","Kuwait":"kw","Kyrgyzstan":"kg",
    "Laos":"la","Latvia":"lv","Lebanon":"lb","Lesotho":"ls","Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt","Luxembourg":"lu",
    "Madagascar":"mg","Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml","Malta":"mt","Marshall Islands":"mh","Mauritania":"mr","Mauritius":"mu","Mexico":"mx","Micronesia":"fm","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me","Morocco":"ma","Mozambique":"mz","Myanmar":"mm",
    "Namibia":"na","Nauru":"nr","Nepal":"np","Netherlands":"nl","New Zealand":"nz","Nicaragua":"ni","Niger":"ne","Nigeria":"ng","North Korea":"kp","North Macedonia":"mk","Norway":"no",
    "Oman":"om",
    "Pakistan":"pk","Palau":"pw","Panama":"pa","Papua New Guinea":"pg","Paraguay":"py","Peru":"pe","Philippines":"ph","Poland":"pl","Portugal":"pt",
    "Qatar":"qa",
    "Romania":"ro","Russia":"ru","Rwanda":"rw",
    "Saint Kitts and Nevis":"kn","Saint Lucia":"lc","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm","Sao Tome and Principe":"st","Saudi Arabia":"sa","Senegal":"sn","Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg","Slovakia":"sk","Slovenia":"si","Solomon Islands":"sb","Somalia":"so","South Africa":"za","South Korea":"kr","South Sudan":"ss","Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr","Sweden":"se","Switzerland":"ch","Syria":"sy",
    "Taiwan":"tw","Tajikistan":"tj","Tanzania":"tz","Thailand":"th","Timor-Leste":"tl","Togo":"tg","Tonga":"to","Trinidad and Tobago":"tt","Tunisia":"tn","Turkey":"tr","Türkiye":"tr","Turkmenistan":"tm","Tuvalu":"tv",
    "Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae","United Kingdom":"gb","United States":"us","Uruguay":"uy","Uzbekistan":"uz",
    "Vanuatu":"vu","Vatican City":"va","Venezuela":"ve","Vietnam":"vn",
    "Yemen":"ye","Zambia":"zm","Zimbabwe":"zw",
    // Territories & common alternates used in visa datasets
    "Hong Kong":"hk","Macao":"mo","Macau":"mo","Kosovo":"xk","Palestine":"ps","Palestinian Territories":"ps","Bolivia (Plurinational State of)":"bo","Congo (Republic)":"cg","Congo (Democratic Republic)":"cd","Ivory Coast":"ci","Cape Verde":"cv","United Republic of Tanzania":"tz","Korea, South":"kr","Korea, North":"kp","Burma":"mm","Curaçao":"cw","Cayman Islands":"ky","Aruba":"aw","Bermuda":"bm","Greenland":"gl","Faroe Islands":"fo","Guernsey":"gg","Jersey":"je","Isle of Man":"im","Puerto Rico":"pr","Guam":"gu","American Samoa":"as","British Virgin Islands":"vg","U.S. Virgin Islands":"vi","Anguilla":"ai","Gibraltar":"gi","Monserrat":"ms","Montserrat":"ms","French Polynesia":"pf","New Caledonia":"nc","Réunion":"re","Reunion":"re","Martinique":"mq","Guadeloupe":"gp","Mayotte":"yt","Cook Islands":"ck","Niue":"nu","Falkland Islands":"fk","Saint Pierre and Miquelon":"pm","Saint Barthélemy":"bl","Sint Maarten":"sx","Bonaire":"bq","Saba":"bq","Turks and Caicos Islands":"tc","Isle Of Man":"im","Bahamas, The":"bs"
  };

  // ================== STATE ==================
  let ALL = [];          // unified normalized entries
  let FILTERED = [];     // filtered view
  const regionsSet = new Set();
  const typeSet = new Set();
  const sourceSet = new Set();

  const $ = (sel)=>document.querySelector(sel);
  const el=(t,c,h)=>{const n=document.createElement(t); if(c) n.className=c; if(h!==undefined) n.innerHTML=h; return n};
  const norm=(s)=> (s||'').toString();
  const key=(s)=> norm(s).trim().toLowerCase();
  const uniqBy=(arr,fn)=> Array.from(new Map(arr.map(i=>[fn(i),i])).values());
  const debounce=(fn,ms=200)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)} };

  // ================== FETCH + NORMALIZE ==================
  async function boot(){
    setStatus('Loading sources…');
    const temp=[]; const errors=[];
    for(const src of SOURCES){
      try{
        const res = await fetch(src.url,{cache:'no-store'});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const data = await res.json();
        const entries = normalizeFromSource(data,src);
        temp.push(...entries);
        sourceSet.add(src.tag);
      }catch(err){
        console.error('Fetch failed',src.url,err);
        errors.push(`${src.tag}: ${err.message}`);
      }
    }

    ALL = mergeEntries(temp);
    renderFilters();
    applyFilters(); // apply filters will now also update status

    if(errors.length){
      setStatus(`${FILTERED.length} of ${ALL.length} countries • ${errors.length} source(s) failed: ${errors.join(' | ')}`);
    }else{
      setStatus(`${FILTERED.length} of ${ALL.length} countries`);
    }
  }

  function normalizeFromSource(raw,src){
    // Very defensive normalization: supports multiple shapes and specially
    // tries to handle E-Visa dataset (and other odd formats).
    const out=[];
    const push=(countryRaw, regions, visaTypes, rawNode)=>{
      // Normalize display country by removing common suffixes like 'E-Visa' or 'Visa-Free'
      const countryStr = (countryRaw||'').toString();
      const display = countryStr.replace(/\s*(E-?Visa|Visa-?Free)\s*$/i,'').trim() || countryStr || 'Unknown';
      const entry={
        country: display,
        regions: Array.from(new Set((regions||[]).filter(Boolean))),
        visaTypes: (visaTypes||[]).map(v=>normalizeVisa(v)).filter(Boolean),
        sources: [src.tag],
        _raw: rawNode
      };
      entry.regions.forEach(r=>regionsSet.add(r));
      entry.visaTypes.forEach(v=> typeSet.add(v.type));
      out.push(entry);
    };

    // Shape A: { visaDatabase: [...] }
    if(raw && typeof raw==='object' && Array.isArray(raw.visaDatabase)){
      raw.visaDatabase.forEach(item=>{
        if(!item) return;
        const c = item.country || item.name;
        const regs=[item.region, src.fallbackRegion];
        let types=[];
        if(Array.isArray(item.visaTypes)) types=item.visaTypes;
        else if(Array.isArray(item.types)) types=item.types;
        else if(item.type) types=[item];
        push(c, regs, types, item);
      });
      return out;
    }

    // Shape B: raw is an array of country objects
    if(Array.isArray(raw)){
      raw.forEach(item=>{
        if(!item) return;
        const c = item.country || item.name;
        const regs=[item.region || item.regionName || src.fallbackRegion, src.fallbackRegion];
        const types = Array.isArray(item.visaTypes)? item.visaTypes : (Array.isArray(item.visa)? item.visa : (item.type?[item]:[]));
        push(c, regs, types, item);
      });
      return out;
    }

    // Shape C: raw is an object with a child array under a different key (common in some exports)
    if(raw && typeof raw==='object'){
      // Attempt common keys
      const candidateKeys = ['countries','data','list','items','final_visa_data','visa','records'];
      for(const k of candidateKeys){
        if(Array.isArray(raw[k])){
          raw[k].forEach(item=>{
            const c = item.country || item.name || item.title;
            const regs=[item.region || item.regionName || src.fallbackRegion, src.fallbackRegion];
            const types = Array.isArray(item.visaTypes)? item.visaTypes : (Array.isArray(item.visa)? item.visa : (item.type?[item]:[]));
            push(c, regs, types, item);
          });
          return out;
        }
      }

      // If there are any array values in raw, pick the best candidate array
      const arrays = Object.values(raw).filter(Array.isArray);
      if(arrays.length){
        // Find the array that looks like countries (has objects with country/name)
        const pick = arrays.find(a=> a.some(it=> it && (it.country || it.name || it.visaTypes || it.visa) ));
        if(pick){
          pick.forEach(item=>{
            const c = item.country || item.name || item.title;
            const regs=[item.region || item.regionName || src.fallbackRegion, src.fallbackRegion];
            const types = Array.isArray(item.visaTypes)? item.visaTypes : (Array.isArray(item.visa)? item.visa : (item.type?[item]:[]));
            push(c, regs, types, item);
          });
          return out;
        }
      }

      // Last resort: sometimes the object itself describes a country
      if(raw.country || raw.name){
        const regs=[raw.region || raw.regionName || src.fallbackRegion, src.fallbackRegion];
        const types = Array.isArray(raw.visaTypes)? raw.visaTypes : (Array.isArray(raw.visa)? raw.visa : (raw.type?[raw]:[]));
        push(raw.country || raw.name, regs, types, raw);
        return out;
      }

      // Special handling for E-Visa structures: some E-Visa files contain a map of countries -> details
      // e.g. { "Country A": { visaTypes: [...] }, "Country B": { ... } }
      const mapLike = Object.entries(raw).filter(([k,v])=> typeof k==='string' && v && typeof v==='object' && (v.visaTypes || v.visa || v.documents || v.visa_info));
      if(mapLike.length){
        mapLike.forEach(([k,v])=>{
          const c = k;
          const regs=[v.region || src.fallbackRegion];
          const types = Array.isArray(v.visaTypes)? v.visaTypes : (Array.isArray(v.visa)? v.visa : []);
          push(c, regs, types, v);
        });
        return out;
      }
    }

    return out;
  }

  function normalizeVisa(v){
    if(!v) return null;
    if(typeof v==='string') return { type: inferType(v), name: v };
    const type = v.type || inferType(v.name) || inferType(v.title) || 'Visa';
    // unify docs field into a flat array of strings/objects where possible
    const docs = Array.isArray(v.documentsRequired)? v.documentsRequired
              : Array.isArray(v.documents)? v.documents
              : Array.isArray(v.requirements)? v.requirements
              : Array.isArray(v.document_list)? v.document_list
              : [];
    return {
      type: norm(type),
      name: norm(v.name || v.type || v.title || type),
      processingTime: norm(v.processingTime || v.processing_time || v.processing || v.time),
      visaValidity: norm(v.visaValidity || v.validity || v.valid_until),
      maxStay: norm(v.maxStay || v.stayValidity || v.max_stay || v.duration),
      visaFees: norm(v.fees || v.visaFees || v.fee || v.cost),
      documents: docs,
      link: v.applicationLink || v.link || v.applyLink || '',
      raw: v
    };
  }

  function inferType(s){
    s=(s||'').toLowerCase();
    if(!s) return '';
    if(s.includes('visa-free')||s.includes('visa free')) return 'Visa-Free';
    if(s.includes('e-visa')||s.includes('e visa')||s.includes('electronic')) return 'E-Visa';
    if(s.includes('tourist')) return 'Tourist Visa';
    if(s.includes('business')) return 'Business Visa';
    if(s.includes('transit')) return 'Transit Visa';
    if(s.includes('student')) return 'Student Visa';
    return 'Visa';
  }

  function mergeEntries(list){
    const m=new Map();
    for(const e of list){
      const k = key(e.country);
      if(!m.has(k)){
        m.set(k,{country:e.country, regions:new Set(e.regions), visaTypes:[], sources:new Set(e.sources), raws:[e._raw], _vt:new Set()});
      }
      const ref=m.get(k);
      e.regions.forEach(r=>ref.regions.add(r));
      e.sources.forEach(s=>ref.sources.add(s));
      ref.raws.push(e._raw);
      e.visaTypes.forEach(v=>{
        const dk = key(v.type+'|'+v.name);
        if(!ref._vt.has(dk)){ ref._vt.add(dk); ref.visaTypes.push(v); }
      });
    }
    return Array.from(m.values()).map(x=>({
      country:x.country,
      regions:Array.from(x.regions).filter(Boolean),
      visaTypes:x.visaTypes,
      sources:Array.from(x.sources),
      raws:x.raws
    })).sort((a,b)=> a.country.localeCompare(b.country));
  }

  // ================== RENDERING ==================
  function renderFilters(){
    const rSel = $('#regionFilter');
    rSel.options.length = 1;
    Array.from(regionsSet).sort().forEach(r=> rSel.add(new Option(r,r)));

    const tSel = $('#visaTypeFilter');
    tSel.options.length = 1;
    Array.from(typeSet).sort().forEach(t=> tSel.add(new Option(t,t)));

    const sSel = $('#sourceFilter');
    sSel.options.length = 1;
    Array.from(sourceSet).sort().forEach(s=> sSel.add(new Option(s,s)));
  }

  function renderCards(list){
    const wrap = $('#cards');
    wrap.innerHTML='';
    if(!list.length){
      wrap.append(el('div','', '<em>No countries match your filters.</em>'));
      return;
    }
    const frag=document.createDocumentFragment();
    for(const item of list){
      const card=el('article','card');
      const head=el('div','card-head');
      const code=flagCode(item.country);
      const img=el('img','flag');
      if(code){ img.src=`https://flagcdn.com/w40/${code}.png`; img.alt=item.country+' flag'; }
      else{ img.classList.add('hidden'); }
      const title=el('div');
      title.append(el('h3','country',item.country));
      const rchips=el('div','chips');
      item.regions.forEach(r=> rchips.append(chip(r)));
      title.append(rchips);
      head.append(img,title);

      const types=el('div','chips');
      uniqBy(item.visaTypes,v=>v.type+"|"+(v.name||'')).forEach(v=> types.append(chip(v.type,'type')));

      const srcs=el('div','sources',`Sources: ${item.sources.join(', ')}`);

      const openBtn=el('button','btn','View details');
      openBtn.addEventListener('click',()=> openDetails(item, code));

      card.append(head, types, srcs, openBtn);
      frag.append(card);
    }
    wrap.append(frag);
  }

  function chip(text,kind){
    const s=el('span','chip'+(kind==='type'?' type':''), text);
    return s;
  }

  function openDetails(item, code){
    const dlg=$('#detailDialog');
    const f=$('#dlgFlag');
    if(code){ f.src=`https://flagcdn.com/w80/${code}.png`; f.classList.remove('hidden'); }
    else{ f.removeAttribute('src'); f.classList.add('hidden'); }
    $('#dlgTitle').textContent=item.country;
    const reg=$('#dlgRegions'); reg.innerHTML=''; item.regions.forEach(r=> reg.append(chip(r)));

    const body=$('#dlgBody');
    body.innerHTML='';

    if(!item.visaTypes.length){
      body.append(el('p','', 'No detailed visa types available.'));
    }else{
      const grid=el('div','grid-2');
      item.visaTypes.forEach(v=>{
        const c=el('div','vt');
        c.append(el('h4','', v.name || v.type));
        const dl=el('dl');
        addRow(dl,'Type', v.type);
        addRow(dl,'Processing Time', v.processingTime);
        addRow(dl,'Visa Validity', v.visaValidity);
        addRow(dl,'Max Stay', v.maxStay);
        addRow(dl,'Fees', v.visaFees);
        if(v.link){
          const a=document.createElement('a'); a.href=v.link; a.target='_blank'; a.rel='noopener'; a.textContent='Application Link';
          const dt=document.createElement('dt'); dt.textContent='Apply';
          const dd=document.createElement('dd'); dd.append(a);
          dl.append(dt,dd);
        }
        c.append(dl);

        // documents may be an array of strings or grouped objects
        if(Array.isArray(v.documents) && v.documents.length){
          const details=el('details');
          const sum=el('summary','', 'Documents Required');
          const ul=el('ul');
          ul.style.margin='8px 0 0';
          ul.style.paddingLeft='18px';
          v.documents.forEach(d=>{
            if(typeof d==='string') ul.append(el('li','',d));
            else if(d && d.name){
              // object like { name, description }
              ul.append(el('li','', d.name + (d.description? (': '+d.description):'')));
            }else if(d && d.documents){
              // grouped category: { category, documents: [{name,description}] }
              const sub = Array.isArray(d.documents)? d.documents.map(x=>x.name||JSON.stringify(x)).join(', '):'';
              ul.append(el('li','', (d.category||'Documents')+': '+sub));
            }else{
              // fallback - show JSON
              ul.append(el('li','', JSON.stringify(d)));
            }
          });
          details.append(sum,ul);
          c.append(details);
        }

        grid.append(c);
      });
      body.append(grid);

      // Also add raw sources/internals section for deep inspection
      const rawSection = el('details');
      rawSection.append(el('summary','', 'Show raw merged data for this country'));
      const pre = el('pre','', JSON.stringify(item.raws || item._raw || {}, null, 2));
      pre.style.whiteSpace='pre-wrap'; pre.style.marginTop='10px'; pre.style.fontSize='12px';
      rawSection.append(pre);
      body.append(rawSection);
    }

    const src=$('#dlgSources');
    src.textContent='Combined from: '+item.sources.join(', ');

    dlg.showModal();
  }

  function addRow(dl,label,val){ if(!val) return; const dt=el('dt','',label); const dd=el('dd','',val); dl.append(dt,dd); }

  // ================== FILTERING ==================
  function applyFilters(){
    const q = key($('#searchInput').value);
    const region = $('#regionFilter').value;
    const vtype = $('#visaTypeFilter').value;
    const src = $('#sourceFilter').value;

    FILTERED = ALL.filter(it=>{
      const qok = !q || key(it.country).includes(q);
      if(!qok) return false;
      const rok = !region || it.regions.includes(region);
      if(!rok) return false;
      const tok = !vtype || it.visaTypes.some(v=> (v.type||'').toLowerCase() === vtype.toLowerCase());
      if(!tok) return false;
      const sok = !src || it.sources.includes(src);
      return sok;
    });

    renderCards(FILTERED);
    // LIVE update the status count every time filters/search changes
    setStatus(`${FILTERED.length} of ${ALL.length} countries`);
  }

  function setStatus(txt){ $('#status').textContent = txt; }

  // ================== FLAG UTIL ==================
  function flagCode(country){
    if(!country) return '';
    // remove suffixes like " E-Visa", " Visa-Free" that may appear in titles
    const base = country.replace(/\s*(E-?Visa|Visa-?Free)\s*$/i,'').trim();
    // try direct mapping
    let iso = ISO2[base];
    if(!iso){
      // sometimes datasets use parentheses, extra phrases
      const cleaned = base.replace(/\(.*?\)/g,'').replace(/Republic of /i,'').replace(/, The$/,'').trim();
      iso = ISO2[cleaned];
    }
    return (iso||'').toLowerCase();
  }

  // ================== EVENTS ==================
  $('#searchInput').addEventListener('input', debounce(applyFilters,200));
  $('#regionFilter').addEventListener('change', applyFilters);
  $('#visaTypeFilter').addEventListener('change', applyFilters);
  $('#sourceFilter').addEventListener('change', applyFilters);
  $('#resetBtn').addEventListener('click', ()=>{
    $('#searchInput').value='';
    $('#regionFilter').selectedIndex=0;
    $('#visaTypeFilter').selectedIndex=0;
    $('#sourceFilter').selectedIndex=0;
    applyFilters();
  });

  // ================== GO ==================
  boot();
  </script>
</body>
</html>
