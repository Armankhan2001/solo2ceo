<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-600 p-2 rounded-lg">
                        <i data-lucide="calendar" class="text-white w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-xl text-slate-800">Events Dashboard</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add Event
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col sm:flex-row gap-4 justify-between items-center mb-6">
            <div class="relative w-full sm:w-96">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="searchInput" placeholder="Search events..." 
                    class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
            <button onclick="fetchData()" class="text-slate-500 hover:text-purple-600 flex items-center gap-2 text-sm">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh List
            </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div id="loading" class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="text-slate-500 mt-2">Loading events...</p>
            </div>

            <div class="overflow-x-auto hidden" id="table-container">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Date & Time</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Event Name</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Location</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Description</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl transform transition-all">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">Add New Event</h3>
                <button onclick="toggleModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <form id="addEventForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Event Name</label>
                    <input type="text" name="Event" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Date (DD/MM/YY)</label>
                        <input type="text" name="Date" placeholder="13/06/25" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Time</label>
                        <input type="text" name="Time" placeholder="2:00 PM" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                    <input type="text" name="Location" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea name="Description" rows="3" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
                </div>

                <button type="submit" id="saveBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors flex justify-center items-center gap-2">
                    <span>Save Event</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR8wohpEHoBs5NaBnspO1lGuG_Kpdn3xMROjvxy6vGHl_nbPnMNrzwkRBwsfR2f6uiwvqUDJiWfZl93/pub?output=csv';
        
        // PASTE YOUR APPS SCRIPT WEB APP URL HERE
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbxUfqhogx7fpW-tVx-EzzcAqIzterA6VVpHlMe8igK4d4BWfQZmJnITPz9EyAOwA7zGng/exec'; 

        // --- LOGIC ---
        let allData = [];
        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');
        const tableContainer = document.getElementById('table-container');

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchData();
        });

        function fetchData() {
            loading.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        }

        function parseDate(dateStr) {
            // Helper to handle DD/MM/YY format
            if(!dateStr) return new Date(0);
            const parts = dateStr.split('/');
            if(parts.length === 3) {
                // assume 20xx for year if 2 digits
                let year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                return new Date(`${parts[1]}/${parts[0]}/${year}`);
            }
            return new Date(dateStr);
        }

        function processData(data) {
            // Sort: Upcoming (Nearest future date) first
            allData = data.sort((a, b) => {
                return parseDate(a.Date) - parseDate(b.Date);
            });

            renderTable(allData);
            loading.classList.add('hidden');
            tableContainer.classList.remove('hidden');
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">No events found</td></tr>';
                return;
            }

            data.forEach(row => {
                if(!row.Event) return;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-900">${row.Date || '-'}</div>
                        <div class="text-xs text-slate-500">${row.Time || ''}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${row.Event}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600">
                        <div class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${row.Location || '-'}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500 max-w-xs truncate" title="${row.Description}">
                        ${row.Description || '-'}
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- SEARCH ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.filter(row => 
                (row.Event && row.Event.toLowerCase().includes(term)) || 
                (row.Location && row.Location.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

        // --- MODAL & FORM ---
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('addEventForm');
        const saveBtn = document.getElementById('saveBtn');

        function toggleModal() {
            modal.classList.toggle('hidden');
        }

        form.addEventListener('submit', e => {
            e.preventDefault();
            if(scriptUrl.includes('PASTE_YOUR')) {
                alert("Please add your Apps Script URL in the code first!");
                return;
            }

            const btnText = saveBtn.innerHTML;
            saveBtn.innerHTML = 'Saving...';
            saveBtn.disabled = true;

            fetch(scriptUrl, { method: 'POST', body: new FormData(form)})
                .then(response => {
                    alert("Event Added Successfully!");
                    form.reset();
                    toggleModal();
                    saveBtn.innerHTML = btnText;
                    saveBtn.disabled = false;
                    // Refresh data after a short delay (Google takes time to index)
                    setTimeout(fetchData, 1000); 
                })
                .catch(error => {
                    console.error('Error!', error.message);
                    alert("Error saving event.");
                    saveBtn.innerHTML = btnText;
                    saveBtn.disabled = false;
                });
        });
    </script>
</body>
</html>