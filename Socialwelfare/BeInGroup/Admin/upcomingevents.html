<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-600 p-2 rounded-lg">
                        <i data-lucide="calendar" class="text-white w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-xl text-slate-800">Events Dashboard</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add Event
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col sm:flex-row gap-4 justify-between items-center mb-6">
            <div class="relative w-full sm:w-96">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="searchInput" placeholder="Search events..." 
                    class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
            <button onclick="fetchData()" class="text-slate-500 hover:text-purple-600 flex items-center gap-2 text-sm">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh List
            </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div id="loading" class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="text-slate-500 mt-2">Loading events...</p>
            </div>

            <div class="overflow-x-auto hidden" id="table-container">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Date & Time</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Event Name</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Location</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Description</th>
                            <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl transform transition-all">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" id="modalTitle">Add New Event</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <form id="eventForm" class="p-6 space-y-4">
                <input type="hidden" id="eventId">

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Event Name</label>
                    <input type="text" id="eventName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Date (DD/MM/YY)</label>
                        <input type="text" id="eventDate" placeholder="13/06/25" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Time</label>
                        <input type="text" id="eventTime" placeholder="2:00 PM" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                    <input type="text" id="eventLocation" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="eventDescription" rows="3" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
                </div>

                <button type="submit" id="saveBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors flex justify-center items-center gap-2">
                    <span>Save Event</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // PASTE YOUR NEW APPS SCRIPT WEB APP URL HERE
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzL6w9vP60HF0tLkD1FDzCYv8jKROGdzkulAifVabGQzb1wHBm13XByPz4Tx4_IaLwM/exec'; 

        // --- STATE & DOM ELEMENTS ---
        let allData = [];
        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');
        const tableContainer = document.getElementById('table-container');
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        const modalTitle = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('saveBtn');

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchData();
        });

        // --- READ (GET) ---
        function fetchData() {
            loading.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            
            fetch(scriptUrl)
                .then(response => response.json())
                .then(response => {
                    if(response.status === 'success') {
                        processData(response.data);
                    } else {
                        alert("Error fetching data");
                    }
                })
                .catch(err => console.error(err));
        }

        function processData(data) {
            // Sort by Date
            allData = data.sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
            renderTable(allData);
            loading.classList.add('hidden');
            tableContainer.classList.remove('hidden');
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No events found</td></tr>';
                return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-900">${row.Date}</div>
                        <div class="text-xs text-slate-500">${row.Time}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${row.Event}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600">
                        <div class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${row.Location}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500 max-w-xs truncate" title="${row.Description}">
                        ${row.Description}
                    </td>
                    <td class="px-6 py-4 text-right whitespace-nowrap text-sm font-medium">
                        <button onclick="editEvent('${row.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="deleteEvent('${row.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- CREATE & UPDATE (POST) ---
        form.addEventListener('submit', e => {
            e.preventDefault();

            const id = document.getElementById('eventId').value;
            const action = id ? 'update' : 'create'; // Decide action based on ID

            const payload = {
                action: action,
                id: id,
                Event: document.getElementById('eventName').value,
                Date: document.getElementById('eventDate').value,
                Time: document.getElementById('eventTime').value,
                Location: document.getElementById('eventLocation').value,
                Description: document.getElementById('eventDescription').value
            };

            const btnText = saveBtn.innerHTML;
            saveBtn.innerHTML = 'Saving...';
            saveBtn.disabled = true;

            fetch(scriptUrl, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    closeModal();
                    fetchData(); // Refresh table
                } else {
                    alert("Error: " + response.message);
                }
            })
            .finally(() => {
                saveBtn.innerHTML = btnText;
                saveBtn.disabled = false;
            });
        });

        // --- DELETE (POST) ---
        function deleteEvent(id) {
            if(!confirm("Are you sure you want to delete this event?")) return;

            const payload = { action: 'delete', id: id };

            fetch(scriptUrl, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    fetchData();
                } else {
                    alert("Error deleting");
                }
            });
        }

        // --- UI HELPERS ---
        function openModal() {
            form.reset();
            document.getElementById('eventId').value = '';
            modalTitle.innerText = "Add New Event";
            saveBtn.innerHTML = "Save Event";
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function editEvent(id) {
            const event = allData.find(e => e.id == id);
            if(!event) return;

            document.getElementById('eventId').value = event.id;
            document.getElementById('eventName').value = event.Event;
            document.getElementById('eventDate').value = event.Date;
            document.getElementById('eventTime').value = event.Time;
            document.getElementById('eventLocation').value = event.Location;
            document.getElementById('eventDescription').value = event.Description;

            modalTitle.innerText = "Edit Event";
            saveBtn.innerHTML = "Update Event";
            modal.classList.remove('hidden');
        }

        function parseDate(dateStr) {
            if(!dateStr) return new Date(0);
            const parts = dateStr.toString().split('/');
            if(parts.length === 3) {
                let year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                return new Date(`${parts[1]}/${parts[0]}/${year}`);
            }
            return new Date(dateStr);
        }

        // Search Filter
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.filter(row => 
                (row.Event && row.Event.toLowerCase().includes(term)) || 
                (row.Location && row.Location.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

    </script>
</body>
</html>